# Critical Section Problem (ржХрзНрж░рж┐ржЯрж┐ржХрзНржпрж╛рж▓ рж╕рзЗржХрж╢ржи рж╕ржорж╕рзНржпрж╛)

## ЁЯУМ Critical Section ржХрж┐?

**Critical Section** рж╣рж▓рзЛ ржХрзЛржбрзЗрж░ рж╕рзЗржЗ ржЕржВрж╢ ржпрзЗржЦрж╛ржирзЗ Shared Resource (ржнрж╛ржЧрж╛ржнрж╛ржЧрж┐ рж░рж┐рж╕рзЛрж░рзНрж╕) ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ ржХрж░рж╛ рж╣ржпрж╝ред

```
тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ                      Process Structure                       тФВ
тФЬтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФд
тФВ                                                             тФВ
тФВ    тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР                  тФВ
тФВ    тФВ         Entry Section               тФВ тЖР ржЕржирзБржорждрж┐ ржирж╛ржУ    тФВ
тФВ    тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ                  тФВ
тФВ                       тФВ                                      тФВ
тФВ                       тЦ╝                                      тФВ
тФВ    тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР                  тФВ
тФВ    тФВ       CRITICAL SECTION              тФВ тЖР Shared Data   тФВ
тФВ    тФВ   (Shared resource access)          тФВ   Access ржХрж░рзЛ   тФВ
тФВ    тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ                  тФВ
тФВ                       тФВ                                      тФВ
тФВ                       тЦ╝                                      тФВ
тФВ    тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР                  тФВ
тФВ    тФВ          Exit Section               тФВ тЖР ржЕржирзБржорждрж┐ ржЫрж╛ржбрж╝рзЛ  тФВ
тФВ    тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ                  тФВ
тФВ                       тФВ                                      тФВ
тФВ                       тЦ╝                                      тФВ
тФВ    тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР                  тФВ
тФВ    тФВ       Remainder Section             тФВ тЖР ржЕржирзНржпрж╛ржирзНржп ржХрзЛржб  тФВ
тФВ    тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ                  тФВ
тФВ                                                             тФВ
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ
```

---

## тЪая╕П рж╕ржорж╕рзНржпрж╛ ржХрж┐?

```
ржпржжрж┐ ржжрзБржЗ ржкрзНрж░рж╕рзЗрж╕ ржПржХрж╕рж╛ржерзЗ Critical Section ржП ржврзЛржХрзЗ:

Process 1           Shared Variable (x=5)        Process 2
    тФВ                       тФВ                        тФВ
    тФВ     Read x=5          тФВ                        тФВ
    тФЬтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтЦ║тФВ                        тФВ
    тФВ                       тФВ      Read x=5          тФВ
    тФВ                       тФВтЧДтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФд
    тФВ     x=5+1=6           тФВ                        тФВ
    тФВ                       тФВ      x=5+1=6           тФВ
    тФВ     Write x=6         тФВ                        тФВ
    тФЬтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтЦ║тФВ      Write x=6         тФВ
    тФВ                       тФВтЧДтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФд
    тФВ                       тФВ                        тФВ
    
    Final Value: x = 6 (рж╣ржУржпрж╝рж╛ ржЙржЪрж┐ржд ржЫрж┐рж▓ 7!)
    
    ржПржЯрж╛ржЗ Race Condition!
```

---

## ЁЯФС рж╕ржорж╛ржзрж╛ржирзЗрж░ рждрж┐ржиржЯрж┐ рж╢рж░рзНржд

### рзз. Mutual Exclusion (ржкрж╛рж░рж╕рзНржкрж░рж┐ржХ ржмрж░рзНржЬржи)
```
ржПржХржЯрж┐ рж╕ржоржпрж╝рзЗ рж╢рзБржзрзБржорж╛рждрзНрж░ ржПржХржЯрж┐ ржкрзНрж░рж╕рзЗрж╕ Critical Section ржП ржерж╛ржХржмрзЗ

тЭМ ржнрзБрж▓:
тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ  P1 in CS    P2 in CS              тФВ тЖР ржжрзБржЬржи ржПржХрж╕рж╛ржерзЗ!
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ

тЬУ рж╕ржарж┐ржХ:
тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ  P1 in CS    тФВ    P2 in CS         тФВ тЖР ржПржХржЬржи рж╢рзЗрж╖ рж╣рж▓рзЗ ржЕржирзНржпржЬржи
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ
```

### рзи. Progress (ржЕржЧрзНрж░ржЧрждрж┐)
```
тАв ржпржжрж┐ ржХрзЛржирзЛ ржкрзНрж░рж╕рзЗрж╕ CS ржП ржирж╛ ржерж╛ржХрзЗ
тАв ржПржмржВ ржХрж┐ржЫрзБ ржкрзНрж░рж╕рзЗрж╕ CS ржП ржврзБржХрждрзЗ ржЪрж╛ржпрж╝
тАв рждрж╛рж╣рж▓рзЗ ржЕржмрж╢рзНржпржЗ ржХрж╛ржЙржХрзЗ ржврзБржХрждрзЗ ржжрж┐рждрзЗ рж╣ржмрзЗ
тАв рж╢рзБржзрзБ CS ржП ржврзБржХрждрзЗ ржЪрж╛ржУржпрж╝рж╛ ржкрзНрж░рж╕рзЗрж╕рж░рж╛ рж╕рж┐ржжрзНржзрж╛ржирзНрждрзЗ ржЕржВрж╢ ржирзЗржмрзЗ

тЭМ ржнрзБрж▓:
P1 wants CS, P2 wants CS
ржХрж┐ржирзНрждрзБ ржХрзЗржЙржЗ ржврзБржХрждрзЗ ржкрж╛рж░ржЫрзЗ ржирж╛ (Deadlock)

тЬУ рж╕ржарж┐ржХ:
P1 ржмрж╛ P2 - ржХрж╛ржЙржХрзЗ ржПржХржЬржиржХрзЗ ржврзБржХрждрзЗ ржжрж┐рждрзЗ рж╣ржмрзЗ
```

### рзй. Bounded Waiting (рж╕рзАржорж╛ржмржжрзНржз ржЕржкрзЗржХрзНрж╖рж╛)
```
ржПржХржЯрж┐ ржкрзНрж░рж╕рзЗрж╕ CS ржП ржврзЛржХрж╛рж░ ржЕржирзБрж░рзЛржз ржХрж░рж╛рж░ ржкрж░
ржЕржирзНржп ржкрзНрж░рж╕рзЗрж╕рж░рж╛ рж╕рж░рзНржмрзЛржЪрзНржЪ ржирж┐рж░рзНржжрж┐рж╖рзНржЯ рж╕ржВржЦрзНржпржХржмрж╛рж░ CS ржП ржврзБржХрждрзЗ ржкрж╛рж░ржмрзЗ
рждрж╛рж░ ржЖржЧрзЗ рж╕рзЗржЗ ржкрзНрж░рж╕рзЗрж╕ржХрзЗ ржврзБржХрждрзЗ ржжрж┐рждрзЗ рж╣ржмрзЗ

тЭМ ржнрзБрж▓:
P1 waits forever while P2 enters CS again and again
(Starvation)

тЬУ рж╕ржарж┐ржХ:
P2 рж╕рж░рзНржмрзЛржЪрзНржЪ n ржмрж╛рж░ ржврзЛржХрж╛рж░ ржкрж░ P1 ржХрзЗ ржврзБржХрждрзЗ ржжрж┐рждрзЗ рж╣ржмрзЗ
```

---

## ЁЯФз Peterson's Solution

### ржжрзБржЯрж┐ ржкрзНрж░рж╕рзЗрж╕рзЗрж░ ржЬржирзНржп Software Solution

```c
// Shared Variables
int turn;           // ржХрж╛рж░ ржкрж╛рж▓рж╛
bool flag[2];       // ржХрзЗ ржврзБржХрждрзЗ ржЪрж╛ржпрж╝

// Process Pi (i = 0 or 1)
void process_i() {
    flag[i] = true;        // ржЖржорж┐ ржврзБржХрждрзЗ ржЪрж╛ржЗ
    turn = j;              // рждрзЛржорж╛ржХрзЗ рж╕рзБржпрзЛржЧ ржжрж┐ржЪрзНржЫрж┐
    
    while (flag[j] && turn == j) {
        // Wait - ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рзЛ
    }
    
    // CRITICAL SECTION
    // ...
    
    flag[i] = false;       // ржЖржорж┐ ржмрзЗрж░рж┐ржпрж╝рзЗ ржЧрзЗржЫрж┐
    
    // REMAINDER SECTION
}
```

### ржХрж┐ржнрж╛ржмрзЗ ржХрж╛ржЬ ржХрж░рзЗ

```
Scenario 1: P0 ржПржХрж╛ ржврзБржХрждрзЗ ржЪрж╛ржпрж╝
тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
flag[0] = true
turn = 1
flag[1] = false тЖТ while loop false
P0 enters CS тЬУ

Scenario 2: ржжрзБржЬржиржЗ ржПржХрж╕рж╛ржерзЗ ржврзБржХрждрзЗ ржЪрж╛ржпрж╝
тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
P0:                          P1:
flag[0] = true              flag[1] = true
turn = 1                    turn = 0

P0 checks: flag[1]=true && turn=1 тЖТ Wait
P1 checks: flag[0]=true && turn=0 тЖТ Wait
                                      тЖУ
P0 keeps waiting (turn=0)
P1: turn=0 тЙа 1 тЖТ P1 enters CS тЬУ
```

### Peterson's Solution ржПрж░ ржкрзНрж░ржорж╛ржг

```
тЬУ Mutual Exclusion:
  тАв ржжрзБржЬржиржЗ CS ржП ржерж╛ржХрждрзЗ ржкрж╛рж░рзЗ ржирж╛
  тАв turn ржПржХрж╕ржоржпрж╝рзЗ ржПржХржЯрж┐ржЗ ржорж╛ржи рж░рж╛ржЦрзЗ

тЬУ Progress:
  тАв ржпржжрж┐ ржПржХржЬржи CS ржП ржирж╛ ржерж╛ржХрзЗ, ржЕржирзНржпржЬржи ржврзБржХрждрзЗ ржкрж╛рж░рзЗ
  тАв flag[j] = false рж╣рж▓рзЗ while loop ржнрж╛ржЩрзЗ

тЬУ Bounded Waiting:
  тАв ржПржХржЬржи CS ржерзЗржХрзЗ ржмрзЗрж░ рж╣рж▓рзЗ flag[i] = false ржХрж░рзЗ
  тАв рждрж╛ржЗ ржЕржирзНржпржЬржи ржЕржмрж╢рзНржпржЗ ржврзБржХрждрзЗ ржкрж╛рж░ржмрзЗ
```

---

## ЁЯФТ Hardware Solutions

### рзз. Test and Set (TAS)

```c
// Hardware instruction (atomic)
bool test_and_set(bool *target) {
    bool rv = *target;
    *target = true;
    return rv;
}

// Usage
bool lock = false;

void process() {
    while (test_and_set(&lock)) {
        // Busy wait
    }
    
    // CRITICAL SECTION
    
    lock = false;
}
```

### рзи. Compare and Swap (CAS)

```c
// Hardware instruction (atomic)
int compare_and_swap(int *value, int expected, int new_val) {
    int temp = *value;
    if (*value == expected) {
        *value = new_val;
    }
    return temp;
}

// Usage
int lock = 0;

void process() {
    while (compare_and_swap(&lock, 0, 1) != 0) {
        // Busy wait
    }
    
    // CRITICAL SECTION
    
    lock = 0;
}
```

---

## тЪб Busy Waiting vs Blocking

### Busy Waiting (Spinlock)
```
while (lock == true) {
    // Keep checking - CPU cycle ржирж╖рзНржЯ
}

рж╕рзБржмрж┐ржзрж╛: ржжрзНрж░рзБржд (ржпржжрж┐ ржЕржкрзЗржХрзНрж╖рж╛ ржХржо рж╣ржпрж╝)
ржЕрж╕рзБржмрж┐ржзрж╛: CPU waste
```

### Blocking (Sleep)
```
if (lock == true) {
    sleep();  // Queue рждрзЗ ржпрж╛ржУ
}

рж╕рзБржмрж┐ржзрж╛: CPU waste рж╣ржпрж╝ ржирж╛
ржЕрж╕рзБржмрж┐ржзрж╛: Context switch overhead
```

---

## ЁЯУК рж╕ржорж╛ржзрж╛ржи рждрзБрж▓ржирж╛

| Solution | Type | Mutual Exclusion | Progress | Bounded Wait |
|----------|------|-----------------|----------|--------------|
| Peterson's | Software | тЬУ | тЬУ | тЬУ |
| Test & Set | Hardware | тЬУ | тЬУ | тЬЧ |
| CAS | Hardware | тЬУ | тЬУ | тЬЧ |
| Semaphore | OS | тЬУ | тЬУ | тЬУ |
| Mutex | OS | тЬУ | тЬУ | тЬУ |

---

## тЭУ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг ржкрзНрж░рж╢рзНржи

**ржкрзНрж░рж╢рзНржи рзз:** Critical Section рж╕ржорж╕рзНржпрж╛рж░ рждрж┐ржиржЯрж┐ рж╢рж░рзНржд ржХрж┐?
**ржЙрждрзНрждрж░:** Mutual Exclusion, Progress, Bounded Waiting

**ржкрзНрж░рж╢рзНржи рзи:** Peterson's Solution ржХрждржЯрж┐ ржкрзНрж░рж╕рзЗрж╕рзЗрж░ ржЬржирзНржп ржХрж╛ржЬ ржХрж░рзЗ?
**ржЙрждрзНрждрж░:** ржжрзБржЗржЯрж┐ ржкрзНрж░рж╕рзЗрж╕рзЗрж░ ржЬржирзНржпред

**ржкрзНрж░рж╢рзНржи рзй:** Test and Set ржП Bounded Waiting ржирзЗржЗ ржХрзЗржи?
**ржЙрждрзНрждрж░:** ржХрзЛржирзЛ ржкрзНрж░рж╕рзЗрж╕ ржЕржирж┐рж░рзНржжрж┐рж╖рзНржЯржХрж╛рж▓ ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рждрзЗ ржкрж╛рж░рзЗ ржХрж╛рж░ржг ржХрзЛржирзЛ ржирж┐рж░рзНржжрж┐рж╖рзНржЯ order ржирзЗржЗред

---
**ржкрж░ржмрж░рзНрждрзА:** [Race Condition](02-race-condition.md)
