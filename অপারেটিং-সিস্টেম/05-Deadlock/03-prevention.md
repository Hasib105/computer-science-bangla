# Deadlock Prevention (ржбрзЗржбрж▓ржХ ржкрзНрж░рждрж┐рж░рзЛржз)

## ЁЯУМ Prevention ржХрж┐?

**Deadlock Prevention** ржорж╛ржирзЗ ржЪрж╛рж░ржЯрж┐ necessary condition ржПрж░ ржпрзЗржХрзЛржирзЛ ржПржХржЯрж┐ ржнрзЗржЩрзЗ ржжрзЗржУржпрж╝рж╛ ржпрж╛рждрзЗ Deadlock ржХржЦржирзЛржЗ рж╣рждрзЗ ржирж╛ ржкрж╛рж░рзЗред

```
тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ                  Deadlock Prevention                        тФВ
тФВ                                                             тФВ
тФВ   Break ANY ONE of the four conditions:                     тФВ
тФВ                                                             тФВ
тФВ   тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР    тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР             тФВ
тФВ   тФВ Mutual Exclusion тФВ    тФВ  Hold and Wait   тФВ             тФВ
тФВ   тФВ     тЭМ Hard      тФВ    тФВ    тЬУ Possible    тФВ             тФВ
тФВ   тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ    тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ             тФВ
тФВ                                                             тФВ
тФВ   тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР    тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР             тФВ
тФВ   тФВ  No Preemption   тФВ    тФВ  Circular Wait   тФВ             тФВ
тФВ   тФВ    тЬУ Possible    тФВ    тФВ    тЬУ Possible    тФВ             тФВ
тФВ   тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ    тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ             тФВ
тФВ                                                             тФВ
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ
```

---

## 1я╕ПтГг Breaking Mutual Exclusion

### рж╕ржорж╕рзНржпрж╛

```
Mutual Exclusion ржнрж╛ржЩрж╛ ржХржарж┐ржи ржХрж╛рж░ржг ржХрж┐ржЫрзБ resource 
рж╕рзНржмрж╛ржнрж╛ржмрж┐ржХржнрж╛ржмрзЗржЗ non-sharable:

тЭМ Printer - ржПржХржЬржиржЗ ржПржХрж╕ржоржпрж╝ print ржХрж░рждрзЗ ржкрж╛рж░рзЗ
тЭМ Tape drive - ржПржХржЯрж╛ржЗ tape ржПржХрж╕ржоржпрж╝
тЭМ Write lock - concurrent write ржЕрж╕ржорзНржнржм

тЬУ Read-only files - share ржХрж░рж╛ ржпрж╛ржпрж╝
тЬУ Memory (reading) - share ржХрж░рж╛ ржпрж╛ржпрж╝
```

### рж╕ржорж╛ржзрж╛ржи: Spooling

```
                     Direct Access (Deadlock possible)
Process 1 тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтЦ║ Printer
Process 2 тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтЦ║ Printer
                     
                     Spooling (No Deadlock)
Process 1 тФАтФАтФАтФАтЦ║ Spooler тФАтФАтФАтФАтЦ║ Printer
Process 2 тФАтФАтФАтФАтЦ║ Spooler тФАтФАтФАтФАтЦ║

Spooler ржПржХржЯрж╛ржЗ process, рж╕рзЗ printer access ржХрж░рзЗ
ржЕржирзНржпрж░рж╛ spooler ржП file ржкрж╛ржарж╛ржпрж╝
```

### рж╕рзАржорж╛ржмржжрзНржзрждрж╛

```
рж╕ржм resource ржП ржкрзНрж░ржпрзЛржЬрзНржп ржиржпрж╝:
тАв Mutex locks spooled ржХрж░рж╛ ржпрж╛ржпрж╝ ржирж╛
тАв Interactive devices ржП spooling ржХржарж┐ржи
```

---

## 2я╕ПтГг Breaking Hold and Wait

### ржкржжрзНржзрждрж┐ рзз: рж╕ржм resource ржПржХрж╕рж╛ржерзЗ ржирж╛ржУ

```c
// ржЖржЧрзЗ рж╕ржм resource request ржХрж░рзЛ
lock_all(R1, R2, R3, R4);

// Critical section
do_work();

// рж╕ржм ржЫрзЗржбрж╝рзЗ ржжрж╛ржУ
unlock_all(R1, R2, R3, R4);
```

```
тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ                                                             тФВ
тФВ  рж╕рзБржмрж┐ржзрж╛:                                                    тФВ
тФВ  тАв Simple                                                   тФВ
тФВ  тАв Deadlock impossible                                      тФВ
тФВ                                                             тФВ
тФВ  ржЕрж╕рзБржмрж┐ржзрж╛:                                                   тФВ
тФВ  тАв Low resource utilization                                 тФВ
тФВ  тАв Process ржЬрж╛ржирзЗ ржирж╛ ржХрзЛржи resource рж▓рж╛ржЧржмрзЗ                      тФВ
тФВ  тАв Starvation possible                                      тФВ
тФВ                                                             тФВ
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ
```

### ржкржжрзНржзрждрж┐ рзи: ржирждрзБржи resource ржЪрж╛ржУржпрж╝рж╛рж░ ржЖржЧрзЗ рж╕ржм ржЫрзЗржбрж╝рзЗ ржжрж╛ржУ

```c
// Phase 1
lock(R1);
use(R1);
unlock(R1);  // R1 ржЫрзЗржбрж╝рзЗ ржжрж╛ржУ

// Phase 2
lock(R2);
lock(R3);    // ржПржЦржи R2, R3 ржирж╛ржУ
use(R2, R3);
unlock(R2);
unlock(R3);
```

---

## 3я╕ПтГг Breaking No Preemption

### ржкржжрзНржзрждрж┐: Resource ржХрзЗржбрж╝рзЗ ржирж╛ржУ

```
тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ                                                             тФВ
тФВ  ржпржжрж┐ P1 ржХрзЛржирзЛ resource R ржЪрж╛ржпрж╝ ржХрж┐ржирзНрждрзБ ржирж╛ ржкрж╛ржпрж╝:               тФВ
тФВ                                                             тФВ
тФВ  Option 1: P1 ржПрж░ рж╕ржм resource ржХрзЗржбрж╝рзЗ ржирж╛ржУ                     тФВ
тФВ            P1 ржкрзБржирж░рж╛ржпрж╝ рж╢рзБрж░рзБ ржерзЗржХрзЗ рж╕ржм request ржХрж░ржмрзЗ           тФВ
тФВ                                                             тФВ
тФВ  Option 2: R ржпрж╛рж░ ржХрж╛ржЫрзЗ ржЖржЫрзЗ рж╕рзЗ ржпржжрж┐ wait ржХрж░ржЫрзЗ               тФВ
тФВ            рждрж╛рж░ ржерзЗржХрзЗ R ржХрзЗржбрж╝рзЗ P1 ржХрзЗ ржжрж╛ржУ                      тФВ
тФВ            ржирж╛ рж╣рж▓рзЗ P1 wait ржХрж░ржмрзЗ                             тФВ
тФВ                                                             тФВ
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ
```

### ржпрзЗржЦрж╛ржирзЗ ржХрж╛ржЬ ржХрж░рзЗ

```
тЬУ CPU - preempt ржХрж░рж╛ ржпрж╛ржпрж╝ (context switch)
тЬУ Memory - swap out ржХрж░рж╛ ржпрж╛ржпрж╝

тЭМ Printer - ржорж╛ржЭржЦрж╛ржирзЗ ржирзЗржУржпрж╝рж╛ ржпрж╛ржпрж╝ ржирж╛
тЭМ Tape drive - partial write corrupt ржХрж░рзЗ
```

### Code Example

```c
bool request_resource(Process p, Resource r) {
    if (r.available) {
        allocate(r, p);
        return true;
    }
    
    Process holder = r.held_by;
    if (holder.is_waiting) {
        // Preempt from waiting process
        preempt(r, holder);
        allocate(r, p);
        return true;
    }
    
    // Release all resources and wait
    release_all(p);
    wait_for(r);
    return false;
}
```

---

## 4я╕ПтГг Breaking Circular Wait

### ржкржжрзНржзрждрж┐: Resource Ordering

```
тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ                                                             тФВ
тФВ  рж╕ржм resource ржХрзЗ ржПржХржЯрж┐ ржиржорзНржмрж░ ржжрж╛ржУ:                            тФВ
тФВ                                                             тФВ
тФВ  R1 (Mutex A) = 1                                          тФВ
тФВ  R2 (Mutex B) = 2                                          тФВ
тФВ  R3 (Printer) = 3                                          тФВ
тФВ  R4 (Disk)    = 4                                          тФВ
тФВ                                                             тФВ
тФВ  ржирж┐ржпрж╝ржо: рж╢рзБржзрзБржорж╛рждрзНрж░ ржХрзНрж░ржоржмрж░рзНржзржорж╛ржи order ржП request ржХрж░рждрзЗ рж╣ржмрзЗ     тФВ
тФВ                                                             тФВ
тФВ  тЬУ Valid:   lock(R1) тЖТ lock(R2) тЖТ lock(R3)                 тФВ
тФВ  тЬУ Valid:   lock(R2) тЖТ lock(R4)                            тФВ
тФВ  тЭМ Invalid: lock(R3) тЖТ lock(R1)  (3 > 1)                  тФВ
тФВ                                                             тФВ
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ
```

### ржХрзЗржи ржХрж╛ржЬ ржХрж░рзЗ?

```
Circular wait ржПрж░ ржЬржирзНржп:
P1 тЖТ R1 тЖТ P2 тЖТ R2 тЖТ P3 тЖТ R3 тЖТ P1

ржПрж░ ржорж╛ржирзЗ:
P1 holds R1, wants R2 (R1 < R2 тЬУ)
P2 holds R2, wants R3 (R2 < R3 тЬУ)
P3 holds R3, wants R1 (R3 < R1 тЬЧ) тЖР Impossible!

рждрж╛ржЗ circular wait рж╣рждрзЗ ржкрж╛рж░рзЗ ржирж╛!
```

### Implementation

```c
#define RESOURCE_A  1
#define RESOURCE_B  2
#define RESOURCE_C  3

pthread_mutex_t mutex_A, mutex_B, mutex_C;

void safe_lock_AB() {
    pthread_mutex_lock(&mutex_A);  // 1
    pthread_mutex_lock(&mutex_B);  // 2
    // Safe: 1 < 2
}

void safe_lock_BC() {
    pthread_mutex_lock(&mutex_B);  // 2
    pthread_mutex_lock(&mutex_C);  // 3
    // Safe: 2 < 3
}

// WRONG - violates ordering
void unsafe_lock_CA() {
    pthread_mutex_lock(&mutex_C);  // 3
    pthread_mutex_lock(&mutex_A);  // 1
    // WRONG: 3 > 1 тЭМ
}
```

---

## ЁЯУК Prevention Methods рждрзБрж▓ржирж╛

| Method | Condition Broken | Practicality | Side Effects |
|--------|-----------------|--------------|--------------|
| Spooling | Mutual Exclusion | Limited | Extra overhead |
| All at once | Hold and Wait | Medium | Low utilization |
| Preemption | No Preemption | Limited | Some resources can't be preempted |
| Ordering | Circular Wait | Good | Programmer burden |

---

## ЁЯТб Best Practice

```
рж╕ржмржЪрзЗржпрж╝рзЗ practical ржкржжрзНржзрждрж┐: Resource Ordering

рзз. рж╕ржм locks ржХрзЗ consistent order ржП acquire ржХрж░рзЛ
рзи. Documentation ржП order specify ржХрж░рзЛ
рзй. Code review рждрзЗ verify ржХрж░рзЛ

// Good pattern
void function() {
    acquire_in_order(lock1, lock2, lock3);
    // work
    release(lock3, lock2, lock1);
}
```

---

## тЭУ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг ржкрзНрж░рж╢рзНржи

**ржкрзНрж░рж╢рзНржи рзз:** Mutual Exclusion ржнрж╛ржЩрж╛ ржХрзЗржи ржХржарж┐ржи?
**ржЙрждрзНрждрж░:** ржХрж┐ржЫрзБ resource (printer, mutex) рж╕рзНржмрж╛ржнрж╛ржмрж┐ржХржнрж╛ржмрзЗржЗ рж╢рзБржзрзБ ржПржХржЬржиржЗ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рждрзЗ ржкрж╛рж░рзЗред ржПржжрзЗрж░ share ржХрж░рж╛ рж╕ржорзНржнржм ржиржпрж╝ред

**ржкрзНрж░рж╢рзНржи рзи:** Resource Ordering рж╕ржмржЪрзЗржпрж╝рзЗ practical ржХрзЗржи?
**ржЙрждрзНрждрж░:**
- рж╕ржм resource ржП ржкрзНрж░ржпрзЛржЬрзНржп
- Programmer manage ржХрж░рждрзЗ ржкрж╛рж░рзЗ
- Runtime overhead ржХржо

**ржкрзНрж░рж╢рзНржи рзй:** Hold and Wait ржнрж╛ржЩрж▓рзЗ Starvation ржХрзЗржи рж╣рждрзЗ ржкрж╛рж░рзЗ?
**ржЙрждрзНрждрж░:** ржпржжрж┐ рж╕ржм resource ржПржХрж╕рж╛ржерзЗ ржЪрж╛ржУржпрж╝рж╛ рж╣ржпрж╝, рждрж╛рж╣рж▓рзЗ popular resources ржПрж░ ржЬржирзНржп ржХрж┐ржЫрзБ process ржЕржирж┐рж░рзНржжрж┐рж╖рзНржЯржХрж╛рж▓ ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рждрзЗ ржкрж╛рж░рзЗред

---
**ржкрзВрж░рзНржмржмрж░рзНрждрзА:** [Resource Allocation Graph](02-resource-allocation-graph.md)  
**ржкрж░ржмрж░рзНрждрзА:** [Deadlock Avoidance](04-avoidance.md)
