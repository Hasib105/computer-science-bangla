# Free Space Management

## ğŸ“Œ Free Space Tracking

Disk à¦ à¦•à§‹à¦¨ blocks free à¦†à¦›à§‡ à¦¸à§‡à¦Ÿà¦¾ track à¦•à¦°à¦¤à§‡ à¦¹à¦¯à¦¼à¥¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                             â”‚
â”‚   Disk Blocks:                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”     â”‚
â”‚   â”‚USEDâ”‚freeâ”‚USEDâ”‚USEDâ”‚freeâ”‚freeâ”‚USEDâ”‚freeâ”‚USEDâ”‚freeâ”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜     â”‚
â”‚     0    1    2    3    4    5    6    7    8    9         â”‚
â”‚                                                             â”‚
â”‚   Free blocks: 1, 4, 5, 7, 9                               â”‚
â”‚                                                             â”‚
â”‚   Methods to track:                                         â”‚
â”‚   1. Bit Vector (Bitmap)                                    â”‚
â”‚   2. Linked List                                            â”‚
â”‚   3. Grouping                                               â”‚
â”‚   4. Counting                                               â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1ï¸âƒ£ Bit Vector (Bitmap)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Bit Vector                             â”‚
â”‚                                                             â”‚
â”‚   Block:   0  1  2  3  4  5  6  7  8  9 10 11 12 ...       â”‚
â”‚   Status:  1  0  1  1  0  0  1  0  1  0  1  1  0  ...      â”‚
â”‚            â†‘     â†‘  â†‘        â†‘     â†‘     â†‘  â†‘              â”‚
â”‚           used  used    free     free    used              â”‚
â”‚                                                             â”‚
â”‚   1 = block is used/allocated                               â”‚
â”‚   0 = block is free                                         â”‚
â”‚                                                             â”‚
â”‚   Example:                                                  â”‚
â”‚   Disk: 1 TB, Block size: 4 KB                             â”‚
â”‚   Total blocks: 2^40 / 2^12 = 2^28 = 256 million           â”‚
â”‚   Bitmap size: 2^28 bits = 32 MB                           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Finding Free Block

```c
// Find first free block
int find_free_block(byte bitmap[], int n) {
    for (int i = 0; i < n; i++) {
        if (bitmap[i] != 0xFF) {  // Not all bits set
            // Find the 0 bit
            for (int j = 0; j < 8; j++) {
                if ((bitmap[i] & (1 << j)) == 0) {
                    return i * 8 + j;
                }
            }
        }
    }
    return -1;  // No free block
}

// Modern CPUs have instructions for this!
// ffs() - find first set bit
// Hardware support makes it FAST
```

### à¦¸à§à¦¬à¦¿à¦§à¦¾ à¦“ à¦…à¦¸à§à¦¬à¦¿à¦§à¦¾

```
âœ“ à¦¸à§à¦¬à¦¿à¦§à¦¾:
â€¢ Simple concept
â€¢ Fast with hardware support
â€¢ Easy to find contiguous blocks
â€¢ Efficient for finding first free

âœ— à¦…à¦¸à§à¦¬à¦¿à¦§à¦¾:
â€¢ Bitmap size can be large
â€¢ Need to keep in memory for efficiency
```

---

## 2ï¸âƒ£ Linked List

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Linked Free List                         â”‚
â”‚                                                             â”‚
â”‚   Free list head â†’ Block 1 â†’ Block 4 â†’ Block 5             â”‚
â”‚                      â”‚         â”‚         â”‚                  â”‚
â”‚                      â–¼         â–¼         â–¼                  â”‚
â”‚                   Block 7 â†’ Block 9 â†’ NULL                  â”‚
â”‚                                                             â”‚
â”‚   Disk visualization:                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”     â”‚
â”‚   â”‚USEDâ”‚FREEâ”‚USEDâ”‚USEDâ”‚FREEâ”‚FREEâ”‚USEDâ”‚FREEâ”‚USEDâ”‚FREEâ”‚     â”‚
â”‚   â”‚    â”‚ â†’4 â”‚    â”‚    â”‚ â†’5 â”‚ â†’7 â”‚    â”‚ â†’9 â”‚    â”‚ Ã¸  â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜     â”‚
â”‚     0    1    2    3    4    5    6    7    8    9         â”‚
â”‚            â†‘                                                â”‚
â”‚          head                                               â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### à¦¸à§à¦¬à¦¿à¦§à¦¾ à¦“ à¦…à¦¸à§à¦¬à¦¿à¦§à¦¾

```
âœ“ à¦¸à§à¦¬à¦¿à¦§à¦¾:
â€¢ No space wasted if few free blocks
â€¢ Free block contains pointer (no extra space)

âœ— à¦…à¦¸à§à¦¬à¦¿à¦§à¦¾:
â€¢ Traversal needed to find all free blocks
â€¢ Finding contiguous blocks is hard
â€¢ Can't keep in memory efficiently
```

---

## 3ï¸âƒ£ Grouping

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Grouping                              â”‚
â”‚                                                             â”‚
â”‚   First free block stores addresses of n free blocks        â”‚
â”‚   Last entry points to another group                        â”‚
â”‚                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚   â”‚ Free Block (index)       â”‚                              â”‚
â”‚   â”‚                          â”‚                              â”‚
â”‚   â”‚ free_blocks[0] = 17     â”‚â”€â”€â”€â”€â–º Block 17 (free)        â”‚
â”‚   â”‚ free_blocks[1] = 28     â”‚â”€â”€â”€â”€â–º Block 28 (free)        â”‚
â”‚   â”‚ free_blocks[2] = 35     â”‚â”€â”€â”€â”€â–º Block 35 (free)        â”‚
â”‚   â”‚ free_blocks[3] = 42     â”‚â”€â”€â”€â”€â–º Block 42 (free)        â”‚
â”‚   â”‚ free_blocks[4] = 50     â”‚â”€â”€â”€â”€â–º Block 50 (another index)â”‚
â”‚   â”‚                          â”‚         â”‚                    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚                    â”‚
â”‚                                        â–¼                    â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                              â”‚ More free block addrs   â”‚   â”‚
â”‚                              â”‚ free_blocks[0] = 55     â”‚   â”‚
â”‚                              â”‚ ...                     â”‚   â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚   à¦¸à§à¦¬à¦¿à¦§à¦¾: Get many free blocks at once                     â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4ï¸âƒ£ Counting

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Counting                              â”‚
â”‚                                                             â”‚
â”‚   Store (start_block, count) pairs                          â”‚
â”‚   Works well when blocks are contiguous                     â”‚
â”‚                                                             â”‚
â”‚   Disk:                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”     â”‚
â”‚   â”‚USEDâ”‚freeâ”‚freeâ”‚freeâ”‚USEDâ”‚freeâ”‚freeâ”‚USEDâ”‚USEDâ”‚freeâ”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜     â”‚
â”‚     0    1    2    3    4    5    6    7    8    9         â”‚
â”‚                                                             â”‚
â”‚   Counting List:                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚   â”‚ (1, 3)    â”‚ (5, 2)    â”‚ (9, 1)    â”‚                    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                             â”‚
â”‚   Meaning:                                                  â”‚
â”‚   â€¢ 3 free blocks starting at block 1                       â”‚
â”‚   â€¢ 2 free blocks starting at block 5                       â”‚
â”‚   â€¢ 1 free block at block 9                                 â”‚
â”‚                                                             â”‚
â”‚   à¦¸à§à¦¬à¦¿à¦§à¦¾: Compact for contiguous free regions              â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Method Comparison

| Method | Space | Allocate | Find Contiguous |
|--------|-------|----------|-----------------|
| Bitmap | Fixed | O(n) or O(1)* | Easy |
| Linked | Variable | O(1) | Hard |
| Grouping | Variable | O(1) | Medium |
| Counting | Variable | O(1) | Easy |

*With hardware support

---

## ğŸ”§ Real File Systems

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                             â”‚
â”‚  ext2/ext3/ext4 (Linux):                                    â”‚
â”‚  â€¢ Block groups with local bitmap                           â”‚
â”‚  â€¢ Bitmap per block group                                   â”‚
â”‚                                                             â”‚
â”‚  NTFS (Windows):                                            â”‚
â”‚  â€¢ $Bitmap file                                             â”‚
â”‚  â€¢ Bitmap approach                                          â”‚
â”‚                                                             â”‚
â”‚  FAT:                                                       â”‚
â”‚  â€¢ FAT table has 0 for free clusters                        â”‚
â”‚  â€¢ Implicit free list                                       â”‚
â”‚                                                             â”‚
â”‚  ZFS, Btrfs:                                                â”‚
â”‚  â€¢ Space maps (sophisticated structures)                    â”‚
â”‚  â€¢ Optimized for large disks                                â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¡ Allocation Strategies

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                             â”‚
â”‚  First Fit:                                                 â”‚
â”‚  â€¢ à¦ªà§à¦°à¦¥à¦® à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ free block allocate à¦•à¦°à§‹                   â”‚
â”‚  â€¢ Fast                                                     â”‚
â”‚                                                             â”‚
â”‚  Best Fit:                                                  â”‚
â”‚  â€¢ à¦¸à¦¬à¦šà§‡à¦¯à¦¼à§‡ à¦›à§‹à¦Ÿ suitable hole                               â”‚
â”‚  â€¢ Minimal fragmentation                                    â”‚
â”‚                                                             â”‚
â”‚  Worst Fit:                                                 â”‚
â”‚  â€¢ à¦¸à¦¬à¦šà§‡à¦¯à¦¼à§‡ à¦¬à¦¡à¦¼ hole                                        â”‚
â”‚  â€¢ Leave large remaining space                              â”‚
â”‚                                                             â”‚
â”‚  Next Fit:                                                  â”‚
â”‚  â€¢ Last allocation à¦à¦° à¦ªà¦° à¦¥à§‡à¦•à§‡ search à¦•à¦°à§‹                  â”‚
â”‚  â€¢ Distributes allocation evenly                            â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## â“ à¦—à§à¦°à§à¦¤à§à¦¬à¦ªà§‚à¦°à§à¦£ à¦ªà§à¦°à¦¶à§à¦¨

**à¦ªà§à¦°à¦¶à§à¦¨ à§§:** Bitmap method à¦ 1TB disk à¦à¦° à¦œà¦¨à§à¦¯ à¦•à¦¤ space à¦²à¦¾à¦—à§‡?
**à¦‰à¦¤à§à¦¤à¦°:** Block size 4KB à¦¹à¦²à§‡:
- Total blocks = 1TB / 4KB = 256M blocks
- Bitmap size = 256M bits = 32 MB

**à¦ªà§à¦°à¦¶à§à¦¨ à§¨:** Linked list method à¦ à¦•à§‡à¦¨ extra space à¦²à¦¾à¦—à§‡ à¦¨à¦¾?
**à¦‰à¦¤à§à¦¤à¦°:** Free block à¦¨à¦¿à¦œà§‡à¦‡ pointer store à¦•à¦°à§‡à¥¤ à¦¯à§‡à¦¹à§‡à¦¤à§ block free, à¦¤à¦¾à¦‡ à¦¤à¦¾à¦° content à¦…à¦¨à§à¦¯ à¦•à¦¿à¦›à§ store à¦•à¦°à¦¤à§‡ à¦ªà¦¾à¦°à§‡à¥¤

**à¦ªà§à¦°à¦¶à§à¦¨ à§©:** Counting method à¦•à¦–à¦¨ à¦­à¦¾à¦²à§‹ à¦•à¦¾à¦œ à¦•à¦°à§‡?
**à¦‰à¦¤à§à¦¤à¦°:** à¦¯à¦–à¦¨ contiguous free blocks à¦¬à§‡à¦¶à¦¿ à¦¥à¦¾à¦•à§‡à¥¤ à¦…à¦¨à§‡à¦• fragmented disk à¦ à¦à¦Ÿà¦¾ efficient à¦¨à¦¯à¦¼à¥¤

---
**à¦ªà§‚à¦°à§à¦¬à¦¬à¦°à§à¦¤à§€:** [File Allocation Methods](03-file-allocation.md)  
**à¦ªà¦°à¦¬à¦°à§à¦¤à§€ à¦«à§‹à¦²à§à¦¡à¦¾à¦°:** [I/O Management](../09-IO-Management/README.md)
