# ржкрж╛ржЗржкрж▓рж╛ржЗржирж┐ржВ
## Chapter 10: Pipelining

---

## ЁЯУМ ржкрж╛ржЗржкрж▓рж╛ржЗржирж┐ржВ ржХрзА?

ржкрж╛ржЗржкрж▓рж╛ржЗржирж┐ржВ рж╣рж▓рзЛ ржПржХрж╛ржзрж┐ржХ ржЗржирзНрж╕ржЯрзНрж░рж╛ржХрж╢ржи рж╕ржорж╛ржирзНрждрж░рж╛рж▓рзЗ ржПржХрзНрж╕рж┐ржХрж┐ржЙржЯ ржХрж░рж╛рж░ ржХрзМрж╢рж▓, ржпрзЗржЦрж╛ржирзЗ ржкрзНрж░рждрж┐ржЯрж┐ ржЗржирзНрж╕ржЯрзНрж░рж╛ржХрж╢ржи ржмрж┐ржнрж┐ржирзНржи рж╕рзНржЯрзЗржЬрзЗ ржерж╛ржХрзЗред

```
рж▓ржирзНржбрзНрж░рж┐рж░ ржЙржжрж╛рж╣рж░ржг:
тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ Without Pipelining:                                          тФВ
тФВ Load1 тЖТ Wash тЖТ Dry тЖТ Fold                                   тФВ
тФВ                          Load2 тЖТ Wash тЖТ Dry тЖТ Fold          тФВ
тФВ                                              Load3 тЖТ ...     тФВ
тФВ                                                              тФВ
тФВ With Pipelining:                                             тФВ
тФВ Load1 тЖТ Wash тЖТ Dry тЖТ Fold                                   тФВ
тФВ      Load2 тЖТ Wash тЖТ Dry тЖТ Fold                              тФВ
тФВ           Load3 тЖТ Wash тЖТ Dry тЖТ Fold                         тФВ
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ
```

---

## ЁЯФД 5-Stage MIPS Pipeline

```
тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФмтФАтФАтФАтФАтФАтФАтФАтФАтФАтФмтФАтФАтФАтФАтФАтФАтФАтФАтФАтФмтФАтФАтФАтФАтФАтФАтФАтФАтФАтФмтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ   IF    тФВ   ID    тФВ   EX    тФВ   MEM   тФВ   WB    тФВ
тФВ Fetch   тФВ Decode  тФВ Execute тФВ Memory  тФВ Write   тФВ
тФВ         тФВ         тФВ         тФВ Access  тФВ Back    тФВ
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФ┤тФАтФАтФАтФАтФАтФАтФАтФАтФАтФ┤тФАтФАтФАтФАтФАтФАтФАтФАтФАтФ┤тФАтФАтФАтФАтФАтФАтФАтФАтФАтФ┤тФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ

IF  = Instruction Fetch (ржЗржирзНрж╕ржЯрзНрж░рж╛ржХрж╢ржи ржЖржирж╛)
ID  = Instruction Decode (ржбрж┐ржХрзЛржб ржУ рж░рзЗржЬрж┐рж╕рзНржЯрж╛рж░ рж░рж┐ржб)
EX  = Execute (ALU ржЕржкрж╛рж░рзЗрж╢ржи)
MEM = Memory Access (Load/Store)
WB  = Write Back (рж░рзЗржЬрж┐рж╕рзНржЯрж╛рж░рзЗ ржлрж▓рж╛ржлрж▓ рж▓рзЗржЦрж╛)
```

### Pipeline Execution

```
Clock Cycle:   1    2    3    4    5    6    7    8
Instruction 1: IF   ID   EX  MEM   WB
Instruction 2:      IF   ID   EX  MEM   WB
Instruction 3:           IF   ID   EX  MEM   WB
Instruction 4:                IF   ID   EX  MEM   WB
```

---

## ЁЯУК Pipeline Performance

### Speedup

```
Without Pipeline:
Time = n ├Ч k ├Ч ╧Д
(n = instructions, k = stages, ╧Д = stage delay)

With Pipeline (ideal):
Time = (k + n - 1) ├Ч ╧Д

Speedup = (n ├Ч k ├Ч ╧Д) / ((k + n - 1) ├Ч ╧Д)

n ржЕржирзЗржХ ржмржбрж╝ рж╣рж▓рзЗ:
Speedup тЙИ k (stages ржПрж░ рж╕ржВржЦрзНржпрж╛)
```

### Throughput

```
Throughput = 1 instruction per clock cycle (ideal)

CPI (ideal) = 1
```

### ржЙржжрж╛рж╣рж░ржг

```
5-stage pipeline, 100 instructions:

Without Pipeline: 100 ├Ч 5 = 500 cycles
With Pipeline: 5 + 100 - 1 = 104 cycles

Speedup = 500/104 тЙИ 4.8x
```

---

## тЪая╕П Pipeline Hazards

### рзз. Structural Hazard
ржПржХржЗ resource ржПржХрж╕рж╛ржерзЗ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рждрзЗ ржЪрж╛ржУржпрж╝рж╛ред

```
рж╕ржорж╕рзНржпрж╛:
IF stage ржУ MEM stage ржжрзБржЯрзЛржЗ ржорзЗржорзЛрж░рж┐ ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ ржЪрж╛ржпрж╝ред

рж╕ржорж╛ржзрж╛ржи:
- Separate instruction/data memory (Harvard)
- Resource duplication
```

### рзи. Data Hazard
ржПржХ ржЗржирзНрж╕ржЯрзНрж░рж╛ржХрж╢ржирзЗрж░ ржлрж▓рж╛ржлрж▓ ржкрж░ржмрж░рзНрждрзА ржЗржирзНрж╕ржЯрзНрж░рж╛ржХрж╢ржирзЗ ржкрзНрж░ржпрж╝рзЛржЬржиред

```
ADD R1, R2, R3    ; R1 = R2 + R3
SUB R4, R1, R5    ; R4 = R1 - R5 (R1 ржкрзНрж░ржпрж╝рзЛржЬржи!)

Clock:    1    2    3    4    5    6
ADD:      IF   ID   EX  MEM  WB
SUB:           IF   ID   ??   тЖР R1 ржПржЦржиржУ рждрзИрж░рж┐ рж╣ржпрж╝ржирж┐!
```

### рзй. Control Hazard
Branch ржЗржирзНрж╕ржЯрзНрж░рж╛ржХрж╢ржирзЗ ржХрзЛржи ржкрже ржирзЗржмрзЗ ржЬрж╛ржирж╛ ржирзЗржЗред

```
BEQ R1, R2, Label
ADD R3, R4, R5    ; Execute ржХрж░ржм ржХрж┐?
SUB R6, R7, R8    ; ржирж╛ржХрж┐ Label ржП ржпрж╛ржм?
```

---

## ЁЯЫая╕П Data Hazard рж╕ржорж╛ржзрж╛ржи

### рзз. Stalling (Bubble)
```
ADD R1, R2, R3
NOP               ; Bubble
NOP               ; Bubble
SUB R4, R1, R5

Clock:    1    2    3    4    5    6    7    8
ADD:      IF   ID   EX  MEM  WB
NOP:           IF   ID   EX  MEM  WB
NOP:                IF   ID   EX  MEM  WB
SUB:                     IF   ID   EX  MEM  WB
```

### рзи. Forwarding/Bypassing
```
ALU ржПрж░ output рж╕рж░рж╛рж╕рж░рж┐ ржкрж░ржмрж░рзНрждрзА ржЗржирзНрж╕ржЯрзНрж░рж╛ржХрж╢ржирзЗ ржкрж╛ржарж╛ржирзЛред

Clock:    1    2    3    4    5    6
ADD:      IF   ID   EX  MEM  WB
                    тФВ
                    тФФтФАтФАтФАтФА Forward тФАтФАтФАтФАтФР
                                      тФВ
SUB:           IF   ID   EX  MEM  WB тЧАтФШ
```

```
тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ                     Forwarding Unit                      тФВ
тФВ                                                          тФВ
тФВ    EX/MEM.Rd тФАтФАтФАтФАтФР                                      тФВ
тФВ                  тФЬтФАтФАтФАтФА Mux тФАтФАтФАтЦ╢ ALU Input               тФВ
тФВ    MEM/WB.Rd тФАтФАтФАтФАтФШ                                      тФВ
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ
```

### рзй. Load-Use Hazard
```
LW R1, 0(R2)      ; Load from memory
ADD R3, R1, R4    ; R1 ржПржЦржиржУ MEM stage ржП!

рж╕ржорж╛ржзрж╛ржи: 1 cycle stall + forwarding

Clock:    1    2    3    4    5    6    7
LW:       IF   ID   EX  MEM  WB
ADD:           IF   ID  STALL EX  MEM  WB
```

---

## ЁЯФА Control Hazard рж╕ржорж╛ржзрж╛ржи

### рзз. Stalling
Branch resolve ржирж╛ рж╣ржУржпрж╝рж╛ ржкрж░рзНржпржирзНржд waitред
```
3 cycle penalty (worst case)
```

### рзи. Branch Prediction
ржЖржЧрзЗржЗ ржЕржирзБржорж╛ржи ржХрж░рж╛ branch ржирзЗржмрзЗ ржХрж┐ржирж╛ред

### рзй. Delayed Branch
Branch ржПрж░ ржкрж░рзЗрж░ slot ржП ржжрж░ржХрж╛рж░рж┐ ржХрж╛ржЬред

```
BEQ R1, R2, Label
ADD R3, R4, R5    ; Delay slot - always execute
```

---

## ЁЯУР Pipeline Registers

```
тФМтФАтФАтФАтФАтФАтФАтФАтФАтФР    тФМтФАтФАтФАтФАтФАтФАтФАтФАтФР    тФМтФАтФАтФАтФАтФАтФАтФАтФАтФР    тФМтФАтФАтФАтФАтФАтФАтФАтФАтФР    тФМтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ   IF   тФВтФАтФАтФАтЦ╢тФВ IF/ID  тФВтФАтФАтФАтЦ╢тФВ   ID   тФВтФАтФАтФАтЦ╢тФВ ID/EX  тФВтФАтФАтФАтЦ╢тФВ   EX   тФВ
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФШ    тФФтФАтФАтФАтФАтФАтФАтФАтФАтФШ    тФФтФАтФАтФАтФАтФАтФАтФАтФАтФШ    тФФтФАтФАтФАтФАтФАтФАтФАтФАтФШ    тФФтФАтФАтФАтФАтФАтФАтФАтФАтФШ
                                                              тФВ
                                                              тЦ╝
тФМтФАтФАтФАтФАтФАтФАтФАтФАтФР    тФМтФАтФАтФАтФАтФАтФАтФАтФАтФР    тФМтФАтФАтФАтФАтФАтФАтФАтФАтФР    тФМтФАтФАтФАтФАтФАтФАтФАтФАтФР    тФМтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ   WB   тФВтЧАтФАтФАтФАтФВ MEM/WB тФВтЧАтФАтФАтФАтФВ  MEM   тФВтЧАтФАтФАтФАтФВ EX/MEM тФВтЧАтФАтФАтФАтФШ
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФШ    тФФтФАтФАтФАтФАтФАтФАтФАтФАтФШ    тФФтФАтФАтФАтФАтФАтФАтФАтФАтФШ    тФФтФАтФАтФАтФАтФАтФАтФАтФАтФШ

Pipeline Register ржП рж╕ржВрж░ржХрзНрж╖рж┐ржд:
- Control signals
- Data values
- Register numbers
```

---

## ЁЯУК Pipeline Performance Factors

```
CPI = Ideal CPI + Stall cycles per instruction
    = 1 + Structural stalls + Data stalls + Control stalls

Actual Speedup = Pipeline Depth / CPI
```

---

## тЬПя╕П ржЕржирзБрж╢рзАрж▓ржирзА

1. 5-stage pipeline ржП 1000 instructions ржПрж░ ржЬржирзНржп speedup ржЧржгржирж╛ ржХрж░рзБржиред
2. Data hazard ржПрж░ 3 ржкрзНрж░ржХрж╛рж░ ржмрзНржпрж╛ржЦрзНржпрж╛ ржХрж░рзБржиред
3. Forwarding ржХрж┐ржнрж╛ржмрзЗ ржХрж╛ржЬ ржХрж░рзЗ diagram ржжрж┐ржпрж╝рзЗ ржжрзЗржЦрж╛ржиред

---

## ЁЯУЪ ржкрж░ржмрж░рзНрждрзА ржЕржзрзНржпрж╛ржпрж╝
[рж╣рзНржпрж╛ржЬрж╛рж░рзНржб ржУ рж╕ржорж╛ржзрж╛ржи](./02-рж╣рзНржпрж╛ржЬрж╛рж░рзНржб-ржУ-рж╕ржорж╛ржзрж╛ржи.md)
