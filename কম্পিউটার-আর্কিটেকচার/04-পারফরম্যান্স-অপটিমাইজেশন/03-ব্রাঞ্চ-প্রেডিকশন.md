# à¦¬à§à¦°à¦¾à¦à§à¦š à¦ªà§à¦°à§‡à¦¡à¦¿à¦•à¦¶à¦¨
## Chapter 12: Branch Prediction

---

## ğŸ“Œ à¦¬à§à¦°à¦¾à¦à§à¦š à¦ªà§à¦°à§‡à¦¡à¦¿à¦•à¦¶à¦¨ à¦•à§€?

à¦¬à§à¦°à¦¾à¦à§à¦š à¦ªà§à¦°à§‡à¦¡à¦¿à¦•à¦¶à¦¨ à¦¹à¦²à§‹ conditional branch à¦à¦° à¦«à¦²à¦¾à¦«à¦² à¦†à¦—à§‡ à¦¥à§‡à¦•à§‡ à¦…à¦¨à§à¦®à¦¾à¦¨ à¦•à¦°à¦¾à¦° à¦•à§Œà¦¶à¦²à¥¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Branch Prediction                           â”‚
â”‚                                                              â”‚
â”‚  Branch Instruction â”€â”€â”€â”€â–¶ Predictor â”€â”€â”€â”€â–¶ Predicted Target  â”‚
â”‚                              â”‚                               â”‚
â”‚                              â–¼                               â”‚
â”‚                    Speculative Execution                     â”‚
â”‚                              â”‚                               â”‚
â”‚                              â–¼                               â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚           â”‚                                    â”‚             â”‚
â”‚      Correct                              Incorrect          â”‚
â”‚      Continue                             Flush & Restart    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Static Branch Prediction

### à§§. Always Not Taken
```
à¦¸à¦¬à¦¸à¦®à¦¯à¦¼ à¦§à¦°à§‡ à¦¨à¦¾à¦“ branch à¦¨à§‡à¦¬à§‡ à¦¨à¦¾à¥¤
Accuracy: ~30-40% (loops à¦ à¦–à¦¾à¦°à¦¾à¦ª)
```

### à§¨. Always Taken
```
à¦¸à¦¬à¦¸à¦®à¦¯à¦¼ à¦§à¦°à§‡ à¦¨à¦¾à¦“ branch à¦¨à§‡à¦¬à§‡à¥¤
Accuracy: ~60-70% (loops à¦ à¦­à¦¾à¦²à§‹)
```

### à§©. BTFN (Backward Taken, Forward Not Taken)
```
Backward branch â†’ Taken (loops)
Forward branch â†’ Not Taken

Accuracy: ~65%
```

### à§ª. Compiler Hints
```
Compiler likely/unlikely hints à¦¦à§‡à¦¯à¦¼à¥¤
if (likely(condition)) { ... }
```

---

## ğŸ”„ Dynamic Branch Prediction

### à§§. 1-Bit Predictor

```
State:
- T (Taken): Predict taken
- NT (Not Taken): Predict not taken

State Transition:
         Taken          Taken
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚    â”‚         â”‚
    â–¼         â”‚    â–¼         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”     â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  NT   â”‚â”€â”€â”€â”€â”€â”¼â”€â”‚   T   â”‚â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”˜
    â–²         â”‚    â–²
    â”‚         â”‚    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
     Not Taken     Not Taken
```

**à¦¸à¦®à¦¸à§à¦¯à¦¾**: Loop à¦ à¦¶à§‡à¦·à§‡ 2à¦Ÿà¦¿ misprediction

```
Loop: for (i=0; i<10; i++)

Iteration:  1  2  3  4  5  6  7  8  9  10  exit
Actual:     T  T  T  T  T  T  T  T  T   T    N
Predict:    N  T  T  T  T  T  T  T  T   T    T
            âœ—  âœ“  âœ“  âœ“  âœ“  âœ“  âœ“  âœ“  âœ“   âœ“    âœ—
```

### à§¨. 2-Bit Saturating Counter

```
States:
- Strongly Not Taken (00)
- Weakly Not Taken (01)
- Weakly Taken (10)
- Strongly Taken (11)

State Diagram:
                    Taken
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                             â”‚
         â–¼                             â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”   Taken   â”Œâ”€â”€â”€â”€â”€â”€â”€â”    â”‚
     â”‚  SNT  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  WNT  â”‚â”€â”€â”€â”€â”˜
     â”‚ (00)  â”‚           â”‚ (01)  â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²                   â”‚
         â”‚                   â”‚ Taken
    Not Taken                â–¼
         â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”   Taken   â”Œâ”€â”€â”€â”€â”€â”€â”€â”
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  WT   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  ST   â”‚
                         â”‚ (10)  â”‚           â”‚ (11)  â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”˜â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â””â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–²     Not Taken     â”‚
                             â”‚                   â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  Not Taken
```

**à¦¸à§à¦¬à¦¿à¦§à¦¾**: à¦à¦•à¦Ÿà¦¿ à¦­à§à¦² prediction à¦ state à¦¸à¦®à§à¦ªà§‚à¦°à§à¦£ à¦¬à¦¦à¦²à¦¾à¦¯à¦¼ à¦¨à¦¾à¥¤

---

## ğŸ—‚ï¸ Branch Target Buffer (BTB)

### BTB à¦•à§€?
Branch target address cache à¦•à¦°à§‡à¥¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Branch Target Buffer                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   PC (Tag)   â”‚   Target     â”‚  Prediction   â”‚   Valid   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   0x1000     â”‚   0x2000     â”‚     11        â”‚     1     â”‚
â”‚   0x1200     â”‚   0x1000     â”‚     10        â”‚     1     â”‚
â”‚   0x1400     â”‚   0x1600     â”‚     01        â”‚     1     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### BTB Operation

```
Fetch Stage:
1. PC à¦¦à¦¿à¦¯à¦¼à§‡ BTB lookup
2. Hit à¦¹à¦²à§‡:
   - Target address à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦—à§‡à¦²
   - Prediction à¦…à¦¨à§à¦¯à¦¾à¦¯à¦¼à§€ fetch
3. Miss à¦¹à¦²à§‡:
   - Sequential fetch
   - Execute à¦ªà¦°à§‡ BTB update
```

---

## ğŸ”— Correlating Predictor

### Local History
à¦¶à§à¦§à§ à¦à¦‡ branch à¦à¦° historyà¥¤

### Global History
à¦¸à¦¬ branch à¦à¦° historyà¥¤

### (m, n) Correlating Predictor
```
m = last m branches à¦à¦° history
n = n-bit counter

Example: (2, 2) predictor
- Last 2 branch outcomes track à¦•à¦°à§‡
- à¦ªà§à¦°à¦¤à¦¿à¦Ÿà¦¿ pattern à¦à¦° à¦œà¦¨à§à¦¯ 2-bit counter

Global History Register (GHR):
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”
â”‚ T â”‚ N â”‚ = 10 (binary)
â””â”€â”€â”€â”´â”€â”€â”€â”˜

Pattern Table:
Pattern â”‚ Counter
   00   â”‚   01
   01   â”‚   11
   10   â”‚   10  â† Use this
   11   â”‚   11
```

---

## ğŸ† Tournament Predictor

```
à¦¦à§à¦Ÿà¦¿ predictor à¦“ à¦à¦•à¦Ÿà¦¿ chooser:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Tournament Predictor                      â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚   Local     â”‚         â”‚   Global    â”‚                â”‚
â”‚  â”‚  Predictor  â”‚         â”‚  Predictor  â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚         â”‚                       â”‚                        â”‚
â”‚         â–¼                       â–¼                        â”‚
â”‚      Pred_L                  Pred_G                      â”‚
â”‚         â”‚                       â”‚                        â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                     â”‚                                    â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚              â”‚   Chooser   â”‚                            â”‚
â”‚              â”‚  (2-bit)    â”‚                            â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                     â”‚                                    â”‚
â”‚                     â–¼                                    â”‚
â”‚              Final Prediction                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§  Neural Branch Prediction

### Perceptron Predictor
```
Machine learning based predictionà¥¤

weights[] = history à¦à¦° à¦¸à¦¾à¦¥à§‡ correlation

prediction = Î£ (weights[i] Ã— history[i])

if (prediction > threshold)
    predict Taken
else
    predict Not Taken
```

---

## ğŸ“ Performance Metrics

```
Accuracy = Correct Predictions / Total Predictions

Misprediction Penalty = Pipeline Flush Cycles

Branch Frequency â‰ˆ 15-25% of instructions

CPI_branch = Base_CPI + (Misprediction_Rate Ã— Penalty Ã— Branch_Frequency)
```

### à¦‰à¦¦à¦¾à¦¹à¦°à¦£
```
Branch frequency: 20%
Misprediction rate: 5%
Penalty: 15 cycles
Base CPI: 1

CPI_impact = 0.05 Ã— 15 Ã— 0.20 = 0.15 cycles

Actual CPI = 1 + 0.15 = 1.15
```

---

## ğŸ¯ Modern Predictors

### TAGE (TAgged GEometric)
```
Multiple tables with different history lengths
Geometric series: 1, 2, 4, 8, 16, ... branches
```

### Perceptron-Based
```
AMD Zen, Intel Haswell+
Neural network based
Very high accuracy (>95%)
```

---

## ğŸ“Š Accuracy Comparison

| Predictor | Accuracy |
|-----------|----------|
| Always Taken | 60-70% |
| 1-bit | 80-85% |
| 2-bit | 85-90% |
| Correlating | 90-95% |
| Tournament | 95-97% |
| TAGE | 97-99% |

---

## âœï¸ à¦…à¦¨à§à¦¶à§€à¦²à¦¨à§€

1. 1-bit à¦“ 2-bit predictor à¦à¦° à¦ªà¦¾à¦°à§à¦¥à¦•à§à¦¯ à¦•à§€?
2. Loop `for(i=0; i<8; i++)` à¦à¦° à¦œà¦¨à§à¦¯ 2-bit predictor à¦à¦° behavior à¦¦à§‡à¦–à¦¾à¦¨à¥¤
3. BTB à¦à¦° à¦•à¦¾à¦œ à¦¬à§à¦¯à¦¾à¦–à§à¦¯à¦¾ à¦•à¦°à§à¦¨à¥¤

---

## ğŸ“š à¦ªà¦°à¦¬à¦°à§à¦¤à§€ à¦…à¦§à§à¦¯à¦¾à¦¯à¦¼
[à¦ªà§à¦¯à¦¾à¦°à¦¾à¦²à§‡à¦² à¦•à¦®à§à¦ªà¦¿à¦‰à¦Ÿà¦¿à¦‚](../05-à¦ªà§à¦¯à¦¾à¦°à¦¾à¦²à§‡à¦²-à¦ªà§à¦°à¦¸à§‡à¦¸à¦¿à¦‚/01-à¦ªà§à¦¯à¦¾à¦°à¦¾à¦²à§‡à¦²-à¦•à¦®à§à¦ªà¦¿à¦‰à¦Ÿà¦¿à¦‚.md)
