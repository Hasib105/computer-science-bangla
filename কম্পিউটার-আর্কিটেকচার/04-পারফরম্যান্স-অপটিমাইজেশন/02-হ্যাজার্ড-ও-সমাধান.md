# рж╣рзНржпрж╛ржЬрж╛рж░рзНржб ржУ рж╕ржорж╛ржзрж╛ржи
## Chapter 11: Pipeline Hazards and Solutions

---

## ЁЯУМ рж╣рзНржпрж╛ржЬрж╛рж░рзНржб ржХрзА?

рж╣рзНржпрж╛ржЬрж╛рж░рзНржб рж╣рж▓рзЛ ржПржоржи ржкрж░рж┐рж╕рзНржерж┐рждрж┐ ржпрзЗржЦрж╛ржирзЗ pipeline ржП ржкрж░ржмрж░рзНрждрзА ржЗржирзНрж╕ржЯрзНрж░рж╛ржХрж╢ржи ржкрж░ржмрж░рзНрждрзА clock cycle ржП execute ржХрж░рждрзЗ ржкрж╛рж░рзЗ ржирж╛ред

---

## ЁЯФз Structural Hazard

### рж╕ржВржЬрзНржЮрж╛
ржПржХржЗ hardware resource ржПржХрж╕рж╛ржерзЗ ржПржХрж╛ржзрж┐ржХ stage ржП ржкрзНрж░ржпрж╝рзЛржЬржиред

### ржЙржжрж╛рж╣рж░ржг
```
Single Memory Port:
Cycle 4:
- Instruction 1: MEM stage (data access)
- Instruction 4: IF stage (instruction fetch)
- ржжрзБржЯрзЛржЗ ржПржХржЗ memory access ржХрж░рждрзЗ ржЪрж╛ржпрж╝!

тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ  Cycle:  1    2    3    4    5    6    7    8     тФВ
тФВ  I1:     IF   ID   EX   MEM  WB                   тФВ
тФВ  I2:          IF   ID   EX   MEM  WB              тФВ
тФВ  I3:               IF   ID   EX   MEM  WB         тФВ
тФВ  I4:                    ??   IF   ID   EX  MEM WB тФВ
тФВ                         тЖС                          тФВ
тФВ                    Structural Hazard!              тФВ
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ
```

### рж╕ржорж╛ржзрж╛ржи

1. **Resource Duplication**
   - ржЖрж▓рж╛ржжрж╛ Instruction ржУ Data Memory
   - ржЖрж▓рж╛ржжрж╛ Instruction ржУ Data Cache

2. **Stalling**
   - ржПржХ cycle wait ржХрж░рж╛

```
Harvard Architecture:
тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР     тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ Instruction CacheтФВ     тФВ    Data Cache    тФВ
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФмтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ     тФФтФАтФАтФАтФАтФАтФАтФАтФАтФмтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ
         тФВ                        тФВ
         тЦ╝                        тЦ╝
      IF stage                MEM stage
```

---

## ЁЯУК Data Hazard

### рж╕ржВржЬрзНржЮрж╛
ржПржХ ржЗржирзНрж╕ржЯрзНрж░рж╛ржХрж╢ржирзЗрж░ ржлрж▓рж╛ржлрж▓ ржкрж░ржмрж░рзНрждрзА ржЗржирзНрж╕ржЯрзНрж░рж╛ржХрж╢ржирзЗрж░ ржЬржирзНржп ржкрзНрж░ржпрж╝рзЛржЬржиред

### ржкрзНрж░ржХрж╛рж░ржнрзЗржж

#### RAW (Read After Write) - True Dependency
```
ADD R1, R2, R3    ; R1 рж▓рзЗржЦрж╛
SUB R4, R1, R5    ; R1 ржкржбрж╝рж╛ тЖР рж╕ржорж╕рзНржпрж╛!
```

#### WAR (Write After Read) - Anti Dependency
```
ADD R1, R2, R3    ; R2 ржкржбрж╝рж╛
SUB R2, R4, R5    ; R2 рж▓рзЗржЦрж╛ тЖР Out-of-order ржП рж╕ржорж╕рзНржпрж╛
```

#### WAW (Write After Write) - Output Dependency
```
ADD R1, R2, R3    ; R1 рж▓рзЗржЦрж╛
MUL R1, R4, R5    ; R1 рж▓рзЗржЦрж╛ тЖР Out-of-order ржП рж╕ржорж╕рзНржпрж╛
```

### RAW Hazard ржЙржжрж╛рж╣рж░ржг

```
ADD R1, R2, R3
SUB R4, R1, R5    ; R1 ржкрзНрж░ржпрж╝рзЛржЬржи
AND R6, R1, R7    ; R1 ржкрзНрж░ржпрж╝рзЛржЬржи
OR  R8, R1, R9    ; R1 ржкрзНрж░ржпрж╝рзЛржЬржи

Cycle:    1    2    3    4    5    6    7    8
ADD:      IF   ID   EX  MEM  WB
                    тЖС        тЖС
                    тФВ        тФФтФАтФА R1 available
                    тФФтФАтФА R1 computed
SUB:           IF   ID   --  --   EX  MEM  WB
                    тЖС
                    R1 needed but not ready!
```

---

## ЁЯЫая╕П Data Hazard рж╕ржорж╛ржзрж╛ржи

### рзз. Stalling (Pipeline Bubble)

```
ADD R1, R2, R3
NOP
NOP
SUB R4, R1, R5

Pipeline:
Cycle:    1    2    3    4    5    6    7    8
ADD:      IF   ID   EX  MEM  WB
bubble:        IF   ID   EX  MEM  WB
bubble:             IF   ID   EX  MEM  WB
SUB:                     IF   ID   EX  MEM  WB
```

**ржЕрж╕рзБржмрж┐ржзрж╛**: Performance loss

### рзи. Data Forwarding (Bypassing)

```
EX/MEM ржмрж╛ MEM/WB register ржерзЗржХрзЗ рж╕рж░рж╛рж╕рж░рж┐ ALU input ржПред

тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ                    Forwarding Paths                          тФВ
тФВ                                                              тФВ
тФВ     ID/EX тФАтФАтФАтФАтФАтФАтФАтЦ╢ EX тФАтФАтФАтФАтФАтФАтФАтЦ╢ EX/MEM тФАтФАтФАтФАтФАтФАтФАтЦ╢ MEM/WB       тФВ
тФВ                    тЦ▓            тФВ                тФВ           тФВ
тФВ                    тФВ            тФВ                тФВ           тФВ
тФВ                    тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФ┤тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ           тФВ
тФВ                       Forward from EX/MEM or MEM/WB         тФВ
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ
```

### Forwarding Conditions

```c
// EX Hazard
if (EX/MEM.RegWrite && 
    EX/MEM.Rd != 0 && 
    EX/MEM.Rd == ID/EX.Rs)
    ForwardA = 10;  // Forward from EX/MEM

// MEM Hazard  
if (MEM/WB.RegWrite && 
    MEM/WB.Rd != 0 && 
    MEM/WB.Rd == ID/EX.Rs)
    ForwardA = 01;  // Forward from MEM/WB
```

### рзй. Load-Use Hazard

```
LW  R1, 0(R2)     ; Load R1
ADD R3, R1, R4    ; Use R1 immediately

рж╕ржорж╕рзНржпрж╛: LW ржПрж░ MEM stage ржП R1 ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝
        ржХрж┐ржирзНрждрзБ ADD ржПрж░ EX stage ржП R1 ржжрж░ржХрж╛рж░

Cycle:    1    2    3    4    5    6    7
LW:       IF   ID   EX  MEM  WB
                        тЖС
                        R1 available here
ADD:           IF   ID  STALL EX  MEM  WB
                    тЖС
                    Need R1 here

рж╕ржорж╛ржзрж╛ржи: 1 cycle stall ржЕржирж┐ржмрж╛рж░рзНржп
```

### Hazard Detection Unit

```c
// Load-Use Hazard Detection
if (ID/EX.MemRead &&
    (ID/EX.Rt == IF/ID.Rs || ID/EX.Rt == IF/ID.Rt))
    Stall pipeline
```

---

## ЁЯФА Control Hazard

### рж╕ржВржЬрзНржЮрж╛
Branch instruction ржПрж░ ржлрж▓рж╛ржлрж▓ ржЬрж╛ржирж╛рж░ ржЖржЧрзЗ ржХрзЛржи instruction fetch ржХрж░рждрзЗ рж╣ржмрзЗ ржмрзБржЭрждрзЗ ржирж╛ ржкрж╛рж░рж╛ред

```
BEQ R1, R2, Target
ADD R3, R4, R5     ; Execute ржХрж░ржм?
SUB R6, R7, R8     ; ржирж╛ржХрж┐ Target ржП ржпрж╛ржм?

Cycle:    1    2    3    4    5
BEQ:      IF   ID   EX  MEM  WB
                    тЖС
                    Branch resolved
ADD:           IF   ID   ??
SUB:                IF   ??
```

### Branch Penalty
```
Without prediction: 3 cycle penalty (typical)
```

---

## ЁЯОп Control Hazard рж╕ржорж╛ржзрж╛ржи

### рзз. Stall Until Branch Resolved

```
BEQ:      IF   ID   EX  MEM  WB
Stall:         --   --   --
Stall:              --   --
Stall:                   --
Next:                         IF   ID   EX
```

**ржЕрж╕рзБржмрж┐ржзрж╛**: High penalty

### рзи. Assume Branch Not Taken

```
рж╕ржмрж╕ржоржпрж╝ ржзрж░рзЗ ржирж╛ржУ branch ржирзЗржмрзЗ ржирж╛ред
ржпржжрж┐ ржнрзБрж▓ рж╣ржпрж╝, flush ржХрж░рзЛред

BEQ:      IF   ID   EX  MEM  WB
ADD:           IF   ID   EX  MEM  WB  тЖР ржзрж░рзЗ ржирж┐рж▓рж╛ржо
SUB:                IF   ID   EX  MEM  WB

Branch taken рж╣рж▓рзЗ: Flush ADD, SUB
```

### рзй. Delayed Branch

```
Branch ржПрж░ ржкрж░рзЗрж░ slot рж╕ржмрж╕ржоржпрж╝ execute рж╣ржпрж╝ред
Compiler useful instruction рж░рж╛ржЦрзЗред

BEQ R1, R2, Target
ADD R3, R4, R5     ; Delay slot - always execute
```

### рзк. Branch Prediction
ржкрж░ржмрж░рзНрждрзА ржЕржзрзНржпрж╛ржпрж╝рзЗ ржмрж┐рж╕рзНрждрж╛рж░рж┐рждред

---

## ЁЯУР Pipeline Flush

```
Branch taken рж╣рж▓рзЗ ржнрзБрж▓ instruction flush:

Cycle:    1    2    3    4    5    6    7
BEQ:      IF   ID   EX  MEM  WB
I1:            IF   ID  FLUSH
I2:                 IF  FLUSH
Target:                      IF   ID   EX  MEM  WB
```

---

## ЁЯУК Hazard Summary

| Hazard Type | ржХрж╛рж░ржг | рж╕ржорж╛ржзрж╛ржи |
|-------------|------|--------|
| Structural | Resource conflict | Duplication, Stall |
| Data (RAW) | Read after write | Forwarding, Stall |
| Data (WAR) | Write after read | Register renaming |
| Data (WAW) | Write after write | Register renaming |
| Control | Branch uncertainty | Prediction, Delay |

---

## тЬПя╕П ржЕржирзБрж╢рзАрж▓ржирзА

1. RAW, WAR, WAW hazard ржПрж░ ржЙржжрж╛рж╣рж░ржг ржжрж┐ржиред
2. Forwarding unit ржПрж░ logic ржмрзНржпрж╛ржЦрзНржпрж╛ ржХрж░рзБржиред
3. ржирж┐ржорзНржирж▓рж┐ржЦрж┐ржд ржХрзЛржбрзЗ hazard identify ржХрж░рзБржи ржПржмржВ forwarding ржжрзЗржЦрж╛ржи:
```
ADD R1, R2, R3
SUB R4, R1, R5
AND R6, R4, R1
```

---

## ЁЯУЪ ржкрж░ржмрж░рзНрждрзА ржЕржзрзНржпрж╛ржпрж╝
[ржмрзНрж░рж╛ржЮрзНржЪ ржкрзНрж░рзЗржбрж┐ржХрж╢ржи](./03-ржмрзНрж░рж╛ржЮрзНржЪ-ржкрзНрж░рзЗржбрж┐ржХрж╢ржи.md)
