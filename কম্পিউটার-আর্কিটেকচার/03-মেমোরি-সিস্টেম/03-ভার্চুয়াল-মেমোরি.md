# à¦­à¦¾à¦°à§à¦šà§à¦¯à¦¼à¦¾à¦² à¦®à§‡à¦®à§‹à¦°à¦¿
## Chapter 09: Virtual Memory

---

## ğŸ“Œ à¦­à¦¾à¦°à§à¦šà§à¦¯à¦¼à¦¾à¦² à¦®à§‡à¦®à§‹à¦°à¦¿ à¦•à§€?

à¦­à¦¾à¦°à§à¦šà§à¦¯à¦¼à¦¾à¦² à¦®à§‡à¦®à§‹à¦°à¦¿ à¦à¦®à¦¨ à¦à¦•à¦Ÿà¦¿ à¦•à§Œà¦¶à¦² à¦¯à¦¾ à¦ªà§à¦°à¦¤à¦¿à¦Ÿà¦¿ à¦ªà§à¦°à§‹à¦—à§à¦°à¦¾à¦®à¦•à§‡ à¦¨à¦¿à¦œà¦¸à§à¦¬ à¦¬à¦¡à¦¼ address space à¦à¦° à¦­à§à¦°à¦® à¦¦à§‡à¦¯à¦¼à¥¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Virtual Memory                        â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚   Program    â”‚         â”‚   Physical   â”‚              â”‚
â”‚  â”‚   Virtual    â”‚   MMU   â”‚    Memory    â”‚              â”‚
â”‚  â”‚   Address    â”‚â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚    (RAM)     â”‚              â”‚
â”‚  â”‚   Space      â”‚         â”‚              â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                  â”‚                       â”‚
â”‚                                  â–¼                       â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚                           â”‚    Disk      â”‚              â”‚
â”‚                           â”‚   (Swap)     â”‚              â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ à¦­à¦¾à¦°à§à¦šà§à¦¯à¦¼à¦¾à¦² à¦®à§‡à¦®à§‹à¦°à¦¿à¦° à¦¸à§à¦¬à¦¿à¦§à¦¾

1. **Isolation**: à¦ªà§à¦°à¦¤à¦¿à¦Ÿà¦¿ à¦ªà§à¦°à§‹à¦¸à§‡à¦¸ à¦†à¦²à¦¾à¦¦à¦¾ address space
2. **Protection**: à¦à¦• à¦ªà§à¦°à§‹à¦¸à§‡à¦¸ à¦…à¦¨à§à¦¯à§‡à¦° à¦®à§‡à¦®à§‹à¦°à¦¿ à¦…à§à¦¯à¦¾à¦•à§à¦¸à§‡à¦¸ à¦•à¦°à¦¤à§‡ à¦ªà¦¾à¦°à§‡ à¦¨à¦¾
3. **Large Address Space**: RAM à¦à¦° à¦šà§‡à¦¯à¦¼à§‡ à¦¬à¦¡à¦¼ à¦ªà§à¦°à§‹à¦—à§à¦°à¦¾à¦® à¦šà¦¾à¦²à¦¾à¦¨à§‹ à¦¸à¦®à§à¦­à¦¬
4. **Sharing**: à¦•à¦¿à¦›à§ à¦®à§‡à¦®à§‹à¦°à¦¿ à¦¶à§‡à¦¯à¦¼à¦¾à¦° à¦•à¦°à¦¾ à¦¯à¦¾à¦¯à¦¼
5. **Simplified Loading**: à¦ªà§à¦°à§‹à¦—à§à¦°à¦¾à¦® à¦¯à§‡à¦•à§‹à¦¨à§‹ address à¦ à¦²à§‹à¦¡ à¦¹à¦¤à§‡ à¦ªà¦¾à¦°à§‡

---

## ğŸ“„ Paging

### Page à¦“ Frame
- **Page**: Virtual memory à¦à¦° à¦¬à§à¦²à¦• (à¦¸à¦¾à¦§à¦¾à¦°à¦£à¦¤ 4 KB)
- **Frame**: Physical memory à¦à¦° à¦¬à§à¦²à¦• (Page à¦à¦° à¦¸à¦®à¦¾à¦¨)

```
Virtual Address Space          Physical Memory
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Page 0   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Frame 3   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Page 1   â”‚â”€â”€â”€â”€â”€â”€â”         â”‚  Frame 0   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Page 2   â”‚      â”‚    â”Œâ”€â”€â”€â–¶â”‚  Frame 1   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚    â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Page 3   â”‚      â””â”€â”€â”€â”€â”¼â”€â”€â”€â–¶â”‚  Frame 2   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Page 4   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  Frame 4   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Virtual Address à¦­à¦¾à¦™à¦¨

```
32-bit Virtual Address, 4 KB page:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Virtual Page Number  â”‚   Page Offset   â”‚
â”‚         (VPN)            â”‚                 â”‚
â”‚        20 bits           â”‚    12 bits      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

VPN = 2Â²â° = 1M pages possible
Offset = 2Â¹Â² = 4096 bytes per page
```

---

## ğŸ“Š Page Table

### Simple Page Table
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Page Table                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  VPN  â”‚ Valid  â”‚ Dirty â”‚  Frame Number  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   0   â”‚   1    â”‚   0   â”‚      3         â”‚
â”‚   1   â”‚   1    â”‚   1   â”‚      7         â”‚
â”‚   2   â”‚   0    â”‚   0   â”‚      -         â”‚  â† Disk à¦
â”‚   3   â”‚   1    â”‚   0   â”‚      1         â”‚
â”‚  ...  â”‚  ...   â”‚  ...  â”‚     ...        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Page Table Entry (PTE) Bits

| Bit | à¦¨à¦¾à¦® | à¦•à¦¾à¦œ |
|-----|-----|-----|
| V | Valid | à¦ªà§‡à¦œ à¦®à§‡à¦®à§‹à¦°à¦¿à¦¤à§‡ à¦†à¦›à§‡ à¦•à¦¿à¦¨à¦¾ |
| D | Dirty | à¦ªà§‡à¦œ à¦ªà¦°à¦¿à¦¬à¦°à§à¦¤à¦¿à¦¤ à¦¹à¦¯à¦¼à§‡à¦›à§‡ à¦•à¦¿à¦¨à¦¾ |
| R | Read | à¦ªà¦¡à¦¼à¦¾à¦° à¦…à¦¨à§à¦®à¦¤à¦¿ |
| W | Write | à¦²à§‡à¦–à¦¾à¦° à¦…à¦¨à§à¦®à¦¤à¦¿ |
| X | Execute | à¦à¦•à§à¦¸à¦¿à¦•à¦¿à¦‰à¦Ÿà§‡à¦° à¦…à¦¨à§à¦®à¦¤à¦¿ |
| U | User | User mode access |
| A | Accessed | à¦¸à¦®à§à¦ªà§à¦°à¦¤à¦¿ à¦…à§à¦¯à¦¾à¦•à§à¦¸à§‡à¦¸ à¦¹à¦¯à¦¼à§‡à¦›à§‡ |

---

## ğŸ¢ Multi-Level Page Table

### à¦¸à¦®à¦¸à§à¦¯à¦¾
32-bit address, 4 KB page = 2Â²â° entries
à¦ªà§à¦°à¦¤à¦¿ entry 4 bytes = 4 MB page table per process!

### à¦¸à¦®à¦¾à¦§à¦¾à¦¨: Multi-Level

```
Two-Level Page Table (32-bit):

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L1 Indexâ”‚ L2 Index â”‚  Offset     â”‚
â”‚  10 bits â”‚ 10 bits  â”‚  12 bits    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L1 Table    â”‚
â”‚ (1024 entries)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â–¶ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â–¶ â”‚ L2 Table    â”‚
â”‚     NULL    â”‚     â”‚ (1024 entries)
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â–¶ â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â–¶ Frame
â”‚             â”‚     â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 64-bit Systems: 4-Level Page Table

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PML4   â”‚ PDPT   â”‚  PD    â”‚  PT    â”‚ Offset  â”‚
â”‚ 9 bits â”‚ 9 bits â”‚ 9 bits â”‚ 9 bits â”‚ 12 bits â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PML4 â†’ Page Map Level 4
PDPT â†’ Page Directory Pointer Table
PD   â†’ Page Directory
PT   â†’ Page Table
```

---

## âš¡ TLB (Translation Lookaside Buffer)

### TLB à¦•à§€?
Page table entry à¦à¦° cacheà¥¤

```
Virtual Address
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    TLB      â”‚
â”‚   (Cache)   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
   Hitâ”‚   Miss
      â”‚     â”‚
      â–¼     â–¼
Physical  Page Table
Address   Lookup
```

### TLB Structure
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TLB                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   VPN    â”‚ ASID  â”‚  PFN    â”‚ V   â”‚   Perm    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  0x123   â”‚  5    â”‚  0x456  â”‚  1  â”‚   RWX     â”‚
â”‚  0x789   â”‚  5    â”‚  0x012  â”‚  1  â”‚   R-X     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ASID = Address Space ID (process identifier)
```

### TLB Miss Handling
1. Hardware Page Table Walk
2. Software TLB Miss Handler

---

## ğŸ“€ Page Fault

### Page Fault à¦•à§€?
à¦¯à¦–à¦¨ à¦…à§à¦¯à¦¾à¦•à§à¦¸à§‡à¦¸ à¦•à¦°à¦¾ à¦ªà§‡à¦œ à¦®à§‡à¦®à§‹à¦°à¦¿à¦¤à§‡ à¦¨à§‡à¦‡à¥¤

### Page Fault Handling
```
1. CPU page fault exception generate à¦•à¦°à§‡
2. OS trap handler à¦šà¦²à§‡
3. Disk à¦¥à§‡à¦•à§‡ page à¦ªà¦¡à¦¼à¦¾ à¦¹à¦¯à¦¼
4. Page table update
5. TLB update
6. Instruction restart
```

### Page Replacement Algorithms

#### FIFO
```
Reference: 1 2 3 4 1 2 5 1 2 3 4 5
Frames: 3

1 2 3 4 1 2 5 1 2 3 4 5
[1]     [4]     [5]     [4]
  [2]     [1]     [1]     [5]
    [3]     [2]     [2]     [3]
```

#### LRU (Least Recently Used)
à¦¸à¦¬à¦šà§‡à¦¯à¦¼à§‡ à¦•à¦® à¦¬à§à¦¯à¦¬à¦¹à§ƒà¦¤ à¦ªà§‡à¦œ à¦ªà§à¦°à¦¤à¦¿à¦¸à§à¦¥à¦¾à¦ªà¦¨

#### Optimal (OPT)
à¦­à¦¬à¦¿à¦·à§à¦¯à¦¤à§‡ à¦¸à¦¬à¦šà§‡à¦¯à¦¼à§‡ à¦¦à§‡à¦°à¦¿à¦¤à§‡ à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦¹à¦¬à§‡ à¦à¦®à¦¨ à¦ªà§‡à¦œ à¦ªà§à¦°à¦¤à¦¿à¦¸à§à¦¥à¦¾à¦ªà¦¨

#### Clock (Second Chance)
```
â”Œâ”€â”€â”€â”
â”‚ 1 â”‚â—€â”€â”€ pointer
â”œâ”€â”€â”€â”¤
â”‚ 0 â”‚
â”œâ”€â”€â”€â”¤
â”‚ 1 â”‚
â”œâ”€â”€â”€â”¤
â”‚ 0 â”‚
â””â”€â”€â”€â”˜

Reference bit 1 à¦¹à¦²à§‡ 0 à¦•à¦°à§‡ à¦à¦—à¦¿à¦¯à¦¼à§‡ à¦¯à¦¾à¦¯à¦¼
0 à¦ªà§‡à¦²à§‡ à¦¸à§‡à¦Ÿà¦¿ à¦ªà§à¦°à¦¤à¦¿à¦¸à§à¦¥à¦¾à¦ªà¦¨
```

---

## ğŸ“ Address Translation à¦‰à¦¦à¦¾à¦¹à¦°à¦£

```
Virtual Address: 0x12345678
Page Size: 4 KB (2Â¹Â² = 4096)

Offset = 0x678 (12 bits)
VPN = 0x12345 (20 bits)

Page Table[0x12345] = Frame 0x789

Physical Address = Frame Ã— Page Size + Offset
                 = 0x789 Ã— 4096 + 0x678
                 = 0x789678
```

---

## âœï¸ à¦…à¦¨à§à¦¶à§€à¦²à¦¨à§€

1. Paging à¦“ Segmentation à¦à¦° à¦ªà¦¾à¦°à§à¦¥à¦•à§à¦¯ à¦•à§€?
2. TLB à¦à¦° à¦•à¦¾à¦œ à¦¬à§à¦¯à¦¾à¦–à§à¦¯à¦¾ à¦•à¦°à§à¦¨à¥¤
3. LRU page replacement simulate à¦•à¦°à§à¦¨: Reference string 1,2,3,4,1,2,5,1,2,3,4,5 à¦à¦¬à¦‚ 3 framesà¥¤

---

## ğŸ“š à¦ªà¦°à¦¬à¦°à§à¦¤à§€ à¦…à¦§à§à¦¯à¦¾à¦¯à¦¼
[à¦ªà¦¾à¦‡à¦ªà¦²à¦¾à¦‡à¦¨à¦¿à¦‚](../04-à¦ªà¦¾à¦°à¦«à¦°à¦®à§à¦¯à¦¾à¦¨à§à¦¸-à¦…à¦ªà¦Ÿà¦¿à¦®à¦¾à¦‡à¦œà§‡à¦¶à¦¨/01-à¦ªà¦¾à¦‡à¦ªà¦²à¦¾à¦‡à¦¨à¦¿à¦‚.md)
