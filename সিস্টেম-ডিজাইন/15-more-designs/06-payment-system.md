# Payment System Design

## ğŸ¯ Requirements

```
Functional:
- Process payments (credit/debit cards)
- Handle multiple payment methods
- Refunds and chargebacks
- Transaction history
- Multi-currency support

Non-Functional:
- 99.999% availability
- Strong consistency (no double charges)
- PCI DSS compliance
- Fraud detection
- Idempotency
```

## ğŸ“Š Payment Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Payment Processing Flow                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚Customerâ”‚â”€â”€â”€â†’â”‚ Payment â”‚â”€â”€â”€â†’â”‚ Payment â”‚â”€â”€â”€â†’â”‚  Payment   â”‚  â”‚
â”‚   â”‚  App   â”‚    â”‚ Gateway â”‚    â”‚ Service â”‚    â”‚ Processor  â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                     â”‚               â”‚          â”‚
â”‚                                     â”‚               â†“          â”‚
â”‚                                     â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚                                     â”‚         â”‚Card      â”‚    â”‚
â”‚                                     â”‚         â”‚Network   â”‚    â”‚
â”‚                                     â”‚         â”‚(Visa/MC) â”‚    â”‚
â”‚                                     â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚                â†“         â”‚
â”‚                                     â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚                                     â”‚         â”‚  Issuing â”‚    â”‚
â”‚                                     â”‚         â”‚   Bank   â”‚    â”‚
â”‚                                     â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚                â”‚         â”‚
â”‚                                     â†“                â”‚         â”‚
â”‚                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚         â”‚
â”‚                               â”‚ Response â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                               â”‚(Approved/â”‚                     â”‚
â”‚                               â”‚Declined) â”‚                     â”‚
â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” Idempotency

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Idempotency Key Pattern                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Problem: Network failures can cause duplicate payments        â”‚
â”‚                                                                 â”‚
â”‚  Client â”€â”€â†’ Server (Request 1)                                â”‚
â”‚         â†Ã—â”€ (Response lost in network)                        â”‚
â”‚  Client â”€â”€â†’ Server (Retry Request 1)                          â”‚
â”‚                                                                 â”‚
â”‚  Without idempotency: User charged twice!                      â”‚
â”‚                                                                 â”‚
â”‚  Solution: Idempotency Key                                     â”‚
â”‚                                                                 â”‚
â”‚  POST /payments                                                 â”‚
â”‚  Idempotency-Key: unique-uuid-from-client                     â”‚
â”‚  {                                                             â”‚
â”‚    "amount": 1000,                                             â”‚
â”‚    "currency": "BDT",                                          â”‚
â”‚    "card_token": "tok_xxx"                                     â”‚
â”‚  }                                                             â”‚
â”‚                                                                 â”‚
â”‚  Server logic:                                                 â”‚
â”‚  1. Check if idempotency_key exists in DB                     â”‚
â”‚  2. If exists, return cached response                         â”‚
â”‚  3. If not, process payment, store with key                   â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ idempotency_keys table                       â”‚              â”‚
â”‚  â”‚                                              â”‚              â”‚
â”‚  â”‚ key          â”‚ response      â”‚ created_at   â”‚              â”‚
â”‚  â”‚ uuid-123     â”‚ {success...}  â”‚ 2024-01-26   â”‚              â”‚
â”‚  â”‚ uuid-456     â”‚ {failed...}   â”‚ 2024-01-26   â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ’° Double-Entry Ledger

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Double-Entry Bookkeeping                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Rule: Every transaction has two entries                       â”‚
â”‚        Debits = Credits                                        â”‚
â”‚                                                                 â”‚
â”‚  User pays à§³1000 for order:                                    â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Transaction ID: TXN-123                              â”‚       â”‚
â”‚  â”‚                                                      â”‚       â”‚
â”‚  â”‚ Entry 1: DEBIT   User Wallet     -à§³1000            â”‚       â”‚
â”‚  â”‚ Entry 2: CREDIT  Merchant Account +à§³1000           â”‚       â”‚
â”‚  â”‚                                                      â”‚       â”‚
â”‚  â”‚ Total: 0 (balanced)                                 â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                 â”‚
â”‚  Refund:                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Transaction ID: TXN-124 (Refund for TXN-123)        â”‚       â”‚
â”‚  â”‚                                                      â”‚       â”‚
â”‚  â”‚ Entry 1: CREDIT  User Wallet     +à§³1000            â”‚       â”‚
â”‚  â”‚ Entry 2: DEBIT   Merchant Account -à§³1000           â”‚       â”‚
â”‚  â”‚                                                      â”‚       â”‚
â”‚  â”‚ Total: 0 (balanced)                                 â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                 â”‚
â”‚  Advantages:                                                   â”‚
â”‚  - Complete audit trail                                        â”‚
â”‚  - Immutable (no updates, only inserts)                       â”‚
â”‚  - Easy reconciliation                                         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—„ï¸ Database Schema

```sql
-- Accounts
CREATE TABLE accounts (
    account_id UUID PRIMARY KEY,
    account_type ENUM('user', 'merchant', 'system'),
    balance DECIMAL(15,2) DEFAULT 0,
    currency CHAR(3),
    created_at TIMESTAMP
);

-- Transactions (immutable ledger)
CREATE TABLE transactions (
    transaction_id UUID PRIMARY KEY,
    idempotency_key VARCHAR(255) UNIQUE,
    status ENUM('pending', 'completed', 'failed'),
    created_at TIMESTAMP
);

-- Ledger entries (double-entry)
CREATE TABLE ledger_entries (
    entry_id UUID PRIMARY KEY,
    transaction_id UUID REFERENCES transactions,
    account_id UUID REFERENCES accounts,
    entry_type ENUM('debit', 'credit'),
    amount DECIMAL(15,2),
    created_at TIMESTAMP
);

-- Ensure balance = SUM(credits) - SUM(debits)
```

## ğŸ” Fraud Detection

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Fraud Detection                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Real-time Checks:                                             â”‚
â”‚  â”œâ”€â”€ Velocity check (too many transactions)                   â”‚
â”‚  â”œâ”€â”€ Amount threshold (unusually large)                        â”‚
â”‚  â”œâ”€â”€ Geographic anomaly (impossible travel)                    â”‚
â”‚  â”œâ”€â”€ Device fingerprint mismatch                               â”‚
â”‚  â””â”€â”€ Blacklisted cards/IPs                                     â”‚
â”‚                                                                 â”‚
â”‚  ML-based Detection:                                           â”‚
â”‚  â”œâ”€â”€ Transaction history patterns                              â”‚
â”‚  â”œâ”€â”€ Merchant category patterns                                â”‚
â”‚  â””â”€â”€ Network analysis (fraud rings)                            â”‚
â”‚                                                                 â”‚
â”‚  Response:                                                     â”‚
â”‚  â”œâ”€â”€ Score < 0.3: Approve                                     â”‚
â”‚  â”œâ”€â”€ Score 0.3-0.7: Additional verification (OTP)             â”‚
â”‚  â””â”€â”€ Score > 0.7: Decline                                     â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ’¡ Key Design Principles

```
âœ“ Exactly-once semantics (idempotency)
âœ“ Immutable ledger
âœ“ Event sourcing for audit
âœ“ Saga pattern for distributed transactions
âœ“ Circuit breaker for payment providers
âœ“ PCI DSS compliance (tokenization)
```

## ğŸ“š à¦ªà¦°à¦¬à¦°à§à¦¤à§€ à¦Ÿà¦ªà¦¿à¦•

[Rate Limiter â†’](./07-rate-limiter.md)
