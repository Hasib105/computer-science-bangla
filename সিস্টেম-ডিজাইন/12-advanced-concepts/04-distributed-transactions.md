# Distributed Transactions

## ğŸ¯ Problem Statement

```
Microservices-à¦ à¦à¦•à¦¾à¦§à¦¿à¦• service-à¦ data change à¦•à¦°à¦¤à§‡ à¦¹à¦²à§‡:

Order Service: Create order
Payment Service: Charge customer
Inventory Service: Reduce stock

à¦¯à¦¦à¦¿ Payment fail à¦•à¦°à§‡, Order à¦“ Inventory rollback à¦•à¦°à¦¤à§‡ à¦¹à¦¬à§‡à¥¤

à¦•à¦¿à¦¨à§à¦¤à§... à¦à¦°à¦¾ à¦†à¦²à¦¾à¦¦à¦¾ databases!
```

## ğŸ“Š Two-Phase Commit (2PC)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Two-Phase Commit                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Coordinator         Participant A         Participant B       â”‚
â”‚      â”‚                    â”‚                     â”‚               â”‚
â”‚      â”‚                    â”‚                     â”‚               â”‚
â”‚      â”‚â”€â”€ Phase 1: Prepare â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚               â”‚
â”‚      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                    â”‚               â”‚
â”‚      â”‚                    â”‚                     â”‚               â”‚
â”‚      â”‚â†â”€â”€ Vote: Yes â”€â”€â”€â”€â”€â”€â”‚                    â”‚               â”‚
â”‚      â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Vote: Yes â”€â”€â”‚               â”‚
â”‚      â”‚                    â”‚                     â”‚               â”‚
â”‚      â”‚â”€â”€ Phase 2: Commit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚               â”‚
â”‚      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                    â”‚               â”‚
â”‚      â”‚                    â”‚                     â”‚               â”‚
â”‚      â”‚â†â”€â”€ ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚               â”‚
â”‚      â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ACK â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
â”‚      â”‚                    â”‚                     â”‚               â”‚
â”‚      â”‚  Transaction Complete                    â”‚               â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

If any votes No â†’ Rollback all
If coordinator fails â†’ Participants blocked!
```

### 2PC Problems
```
âŒ Blocking: Participants wait for coordinator
âŒ Single point of failure: Coordinator
âŒ Performance: Multiple round trips
âŒ Not suitable for microservices
```

## ğŸ”„ Saga Pattern

```
Saga = Local transactions + Compensating actions

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Saga Pattern                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Order           Payment         Inventory                      â”‚
â”‚  Service         Service         Service                        â”‚
â”‚     â”‚               â”‚               â”‚                           â”‚
â”‚     â”‚ T1: Create    â”‚               â”‚                           â”‚
â”‚     â”‚ Order         â”‚               â”‚                           â”‚
â”‚     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’               â”‚                           â”‚
â”‚     â”‚               â”‚ T2: Charge    â”‚                           â”‚
â”‚     â”‚               â”‚ Payment       â”‚                           â”‚
â”‚     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’                           â”‚
â”‚     â”‚               â”‚               â”‚ T3: Reserve               â”‚
â”‚     â”‚               â”‚               â”‚ Stock                     â”‚
â”‚     â”‚               â”‚               â”‚â”€â”€â†’                        â”‚
â”‚     â”‚               â”‚               â”‚                           â”‚
â”‚     â”‚          SUCCESS              â”‚                           â”‚
â”‚     â”‚               â”‚               â”‚                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                                                                 â”‚
â”‚  If T3 fails:                                                   â”‚
â”‚     â”‚               â”‚               â”‚                           â”‚
â”‚     â”‚               â”‚â†â”€â”€ C2: Refund â”€â”‚                          â”‚
â”‚     â”‚â†â”€â”€ C1: Cancel â”€â”‚               â”‚                          â”‚
â”‚     â”‚ Order         â”‚               â”‚                           â”‚
â”‚     â”‚               â”‚               â”‚                           â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T = Transaction
C = Compensating transaction
```

### Saga Types

#### Choreography (Event-driven)
```
No central coordinatorà¥¤

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Choreography Saga                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”‚  Order Service                                             â”‚
â”‚      â”‚                                                     â”‚
â”‚      â”‚ OrderCreated event                                  â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Message Bus                      â”‚
â”‚                               â”‚                            â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚                    â†“                     â†“                â”‚
â”‚              Payment Service      Inventory Service        â”‚
â”‚                    â”‚                     â”‚                â”‚
â”‚              PaymentDone           StockReserved          â”‚
â”‚                    â”‚                     â”‚                â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                               â†“                           â”‚
â”‚                        Order Completed                    â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Orchestration (Central coordinator)
```
Saga Orchestrator controls flowà¥¤

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Orchestration Saga                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”‚                  Saga Orchestrator                         â”‚
â”‚                        â”‚                                   â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚        â†“               â†“               â†“                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚   â”‚  Order  â”‚    â”‚ Payment â”‚    â”‚Inventoryâ”‚              â”‚
â”‚   â”‚ Service â”‚    â”‚ Service â”‚    â”‚ Service â”‚              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                            â”‚
â”‚   Orchestrator:                                            â”‚
â”‚   1. Tell Order to create                                  â”‚
â”‚   2. Tell Payment to charge                                â”‚
â”‚   3. Tell Inventory to reserve                             â”‚
â”‚   4. If fail: compensate in reverse                        â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âš–ï¸ Choreography vs Orchestration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Aspect        â”‚   Choreography     â”‚   Orchestration    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Coupling           â”‚ Loose              â”‚ Tight to orchestor â”‚
â”‚ Complexity         â”‚ Simple initially   â”‚ Complex initially  â”‚
â”‚ Visibility         â”‚ Hard to track      â”‚ Centralized view   â”‚
â”‚ Scalability        â”‚ Better             â”‚ Orchestrator SPOF  â”‚
â”‚ Debugging          â”‚ Harder             â”‚ Easier             â”‚
â”‚ Best for           â”‚ Simple flows       â”‚ Complex flows      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ’¡ Saga Implementation Tips

```python
# Saga State Machine
class OrderSaga:
    def __init__(self, order_id):
        self.order_id = order_id
        self.state = 'STARTED'
        
    def execute(self):
        try:
            # Step 1
            self.create_order()
            self.state = 'ORDER_CREATED'
            
            # Step 2
            self.charge_payment()
            self.state = 'PAYMENT_CHARGED'
            
            # Step 3
            self.reserve_inventory()
            self.state = 'COMPLETED'
            
        except PaymentError:
            self.compensate_order()
            self.state = 'FAILED'
            
        except InventoryError:
            self.refund_payment()
            self.compensate_order()
            self.state = 'FAILED'
    
    def compensate_order(self):
        # Cancel order
        pass
    
    def refund_payment(self):
        # Refund customer
        pass
```

## âœ… Best Practices

```
âœ“ Idempotent operations
âœ“ Compensating actions for each step
âœ“ Saga state persistence
âœ“ Timeout handling
âœ“ Dead letter queue for failures
âœ“ Monitoring and alerting
```

## ğŸ“š à¦ªà¦°à¦¬à¦°à§à¦¤à§€ à¦Ÿà¦ªà¦¿à¦•

[Consistent Hashing â†’](./05-consistent-hashing.md)
