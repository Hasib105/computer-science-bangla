# Event Sourcing & CQRS

## ğŸ¯ Event Sourcing à¦•à¦¿?

**Event Sourcing** à¦¹à¦²à§‹ à¦à¦®à¦¨ à¦à¦•à¦Ÿà¦¿ pattern à¦¯à§‡à¦–à¦¾à¦¨à§‡ application state-à¦à¦° changes events à¦¹à¦¿à¦¸à§‡à¦¬à§‡ store à¦•à¦°à¦¾ à¦¹à¦¯à¦¼à¥¤

```
Traditional (State-based):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Account: { balance: 1000 }   â”‚
â”‚  (à¦¶à§à¦§à§ current state à¦œà¦¾à¦¨à¦¿)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Event Sourcing:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Event 1: AccountCreated(0)   â”‚
â”‚  Event 2: Deposited(500)      â”‚
â”‚  Event 3: Deposited(700)      â”‚
â”‚  Event 4: Withdrawn(200)      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  Current Balance: 1000        â”‚
â”‚  (à¦ªà§à¦°à§‹ history à¦œà¦¾à¦¨à¦¿)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š Event Store Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Event Sourcing                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Command          Event Store              Read Model       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚Create â”‚â”€â”€â”€â”€â”€â”€â†’â”‚ Event 1   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚           â”‚    â”‚
â”‚  â”‚Accountâ”‚       â”‚ Event 2   â”‚           â”‚  Account  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ Event 3   â”‚           â”‚  View     â”‚    â”‚
â”‚                  â”‚ Event 4   â”‚           â”‚           â”‚    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”       â”‚ Event 5   â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”‚Depositâ”‚â”€â”€â”€â”€â”€â”€â†’â”‚ ...       â”‚                â†‘           â”‚
â”‚  â”‚Money  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                       â”‚           â”‚
â”‚                       â”‚    Projection         â”‚           â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Events are:
- Immutable
- Append-only
- Source of truth
```

## ğŸ”„ CQRS (Command Query Responsibility Segregation)

```
CQRS = à¦†à¦²à¦¾à¦¦à¦¾ models for read à¦“ writeà¥¤

Traditional CRUD:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Single Model              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚      Domain Model           â”‚   â”‚
â”‚  â”‚  (Read + Write together)    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â†“                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚        Database             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CQRS:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                             â”‚
â”‚  Commands                              Queries              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  Write    â”‚                       â”‚   Read    â”‚         â”‚
â”‚  â”‚  Model    â”‚                       â”‚   Model   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â”‚
â”‚        â”‚                                   â”‚               â”‚
â”‚        â†“                                   â†“               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      Sync/Event      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  Write    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚   Read    â”‚         â”‚
â”‚  â”‚  DB       â”‚                      â”‚   DB      â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—ï¸ Event Sourcing + CQRS Together

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Event Sourcing + CQRS                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  User                                                            â”‚
â”‚   â”‚                                                              â”‚
â”‚   â”‚  Command: PlaceOrder                                         â”‚
â”‚   â†“                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚  â”‚   Command    â”‚                                                â”‚
â”‚  â”‚   Handler    â”‚                                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚         â”‚                                                        â”‚
â”‚         â†“                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    Publish    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ Event Store  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ Message Bus  â”‚                â”‚
â”‚  â”‚ OrderPlaced  â”‚               â”‚   (Kafka)    â”‚                â”‚
â”‚  â”‚ OrderShipped â”‚               â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚  â”‚ OrderDeliverdâ”‚                      â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚                        â”‚
â”‚                                        â”‚                        â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚         â”‚                              â”‚                  â”‚     â”‚
â”‚         â†“                              â†“                  â†“     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚   Orders     â”‚              â”‚  Analytics   â”‚  â”‚ Shipping   â”‚â”‚
â”‚  â”‚   View       â”‚              â”‚   Service    â”‚  â”‚  Service   â”‚â”‚
â”‚  â”‚  (Read DB)   â”‚              â”‚              â”‚  â”‚            â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚         â†‘                                                       â”‚
â”‚         â”‚ Query: GetOrderDetails                                â”‚
â”‚  User â”€â”€â”˜                                                       â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ’¡ Event Design

```python
# Event Examples
class OrderPlaced:
    order_id: str
    customer_id: str
    items: List[OrderItem]
    total_amount: Decimal
    placed_at: datetime

class OrderShipped:
    order_id: str
    tracking_number: str
    carrier: str
    shipped_at: datetime

class OrderDelivered:
    order_id: str
    delivered_at: datetime
    signature: str

# Event Store
events = [
    OrderPlaced(order_id="123", ...),
    OrderShipped(order_id="123", ...),
    OrderDelivered(order_id="123", ...)
]

# Rebuild state from events
def get_order_state(events):
    state = {}
    for event in events:
        if isinstance(event, OrderPlaced):
            state['status'] = 'placed'
            state['items'] = event.items
        elif isinstance(event, OrderShipped):
            state['status'] = 'shipped'
            state['tracking'] = event.tracking_number
        elif isinstance(event, OrderDelivered):
            state['status'] = 'delivered'
    return state
```

## âœ… à¦¸à§à¦¬à¦¿à¦§à¦¾

```
Event Sourcing:
âœ“ Complete audit trail
âœ“ Time travel (any past state)
âœ“ Debug by replaying events
âœ“ Event-driven architecture natural fit
âœ“ No data loss

CQRS:
âœ“ Optimized read/write models
âœ“ Independent scaling
âœ“ Better performance
âœ“ Simpler models
```

## âŒ à¦šà§à¦¯à¦¾à¦²à§‡à¦à§à¦œ

```
Event Sourcing:
âœ— Event schema evolution
âœ— Storage growth
âœ— Complexity
âœ— Eventual consistency

CQRS:
âœ— Sync between models
âœ— More infrastructure
âœ— Debugging harder
```

## ğŸ“š à¦ªà¦°à¦¬à¦°à§à¦¤à§€ à¦Ÿà¦ªà¦¿à¦•

[Distributed Transactions â†’](./04-distributed-transactions.md)
