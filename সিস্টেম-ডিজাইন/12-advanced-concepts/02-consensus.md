# Consensus Algorithms

## ğŸ¯ Consensus à¦•à¦¿?

**Consensus** à¦¹à¦²à§‹ distributed system-à¦ à¦¸à¦¬ nodes-à¦•à§‡ à¦à¦•à¦Ÿà¦¿ à¦®à¦¾à¦¨à§‡ à¦à¦•à¦®à¦¤ à¦•à¦°à¦¾à¦¨à§‹à¥¤

```
Problem:
Node A: "Value is 5"
Node B: "Value is 7"
Node C: "Value is 5"

Consensus: All agree on one value
After consensus: All say "Value is 5"
```

## ğŸ“Š Why Consensus is Hard?

```
Challenges:
â”œâ”€â”€ Nodes can fail
â”œâ”€â”€ Messages can be delayed/lost
â”œâ”€â”€ Network partitions
â””â”€â”€ Byzantine failures (malicious nodes)

FLP Impossibility Theorem:
In async system with even 1 faulty node,
deterministic consensus is impossible.

Practical systems use timeouts to work around this.
```

## ğŸ”„ Paxos Algorithm

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Paxos Roles                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Proposer: Proposes values                                  â”‚
â”‚  Acceptor: Votes on proposals                               â”‚
â”‚  Learner: Learns the decided value                          â”‚
â”‚                                                             â”‚
â”‚  (A node can have multiple roles)                           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Paxos Phases:

Phase 1a: Prepare
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    Prepare(n)    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Proposer â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ Acceptor â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  "I want to propose with number n"

Phase 1b: Promise
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    Promise(n)    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Proposer â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Acceptor â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  "I promise not to accept < n"

Phase 2a: Accept
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  Accept(n,value) â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Proposer â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ Acceptor â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  "Accept this value with number n"

Phase 2b: Accepted
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    Accepted(n)   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Proposer â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Acceptor â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  "I accepted the value"
```

## ğŸ—ï¸ Raft Algorithm

```
Raft is designed to be understandableà¥¤

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Raft States                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   timeout   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  wins   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Follower â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ Candidate â”‚â”€â”€â”€â”€â”€â”€â”€â†’â”‚ Leader â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚       â†‘                         â”‚                    â”‚      â”‚
â”‚       â”‚         loses           â”‚                    â”‚      â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚      â”‚
â”‚       â†‘                                              â”‚      â”‚
â”‚       â”‚              discovers leader                â”‚      â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Leader Election:

1. Follower times out (no heartbeat)
2. Becomes Candidate, votes for self
3. Requests votes from others
4. Gets majority â†’ becomes Leader
5. Sends heartbeats to maintain leadership
```

### Raft Log Replication
```
Leader receives write â†’ Appends to log â†’ Replicates to followers

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Log Replication                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”‚  Leader:   [1][2][3][4][5]                                â”‚
â”‚                  â†“                                         â”‚
â”‚  Follower A: [1][2][3][4][5] âœ“                            â”‚
â”‚  Follower B: [1][2][3][4][5] âœ“                            â”‚
â”‚  Follower C: [1][2][3]       (lagging)                    â”‚
â”‚                                                            â”‚
â”‚  Committed: Entries replicated to majority                â”‚
â”‚  Entry 4 committed (Leader + A + B = 3/5)                 â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âš–ï¸ Paxos vs Raft

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Aspect        â”‚      Paxos       â”‚        Raft          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Understandability  â”‚ Complex          â”‚ Designed for clarity â”‚
â”‚ Leader             â”‚ Optional         â”‚ Required             â”‚
â”‚ Log structure      â”‚ Flexible         â”‚ Strict ordering      â”‚
â”‚ Membership change  â”‚ Complex          â”‚ Joint consensus      â”‚
â”‚ Industry use       â”‚ Google Chubby    â”‚ etcd, Consul         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ Real-World Usage

```
Raft-based Systems:
â”œâ”€â”€ etcd (Kubernetes)
â”œâ”€â”€ Consul (HashiCorp)
â”œâ”€â”€ CockroachDB
â”œâ”€â”€ TiKV
â””â”€â”€ RethinkDB

Paxos-based Systems:
â”œâ”€â”€ Google Chubby
â”œâ”€â”€ Google Spanner
â”œâ”€â”€ Apache ZooKeeper (ZAB, Paxos-like)
â””â”€â”€ AWS DynamoDB
```

## ğŸ’¡ Byzantine Fault Tolerance (BFT)

```
Handles malicious nodesà¥¤

PBFT (Practical BFT):
Requires 3f + 1 nodes for f faulty nodes

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client â†’ Primary â†’ Replicas â†’ Client  â”‚
â”‚                                        â”‚
â”‚  Phases:                               â”‚
â”‚  1. Pre-prepare                        â”‚
â”‚  2. Prepare                            â”‚
â”‚  3. Commit                             â”‚
â”‚                                        â”‚
â”‚  Used in: Hyperledger Fabric           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“š à¦ªà¦°à¦¬à¦°à§à¦¤à§€ à¦Ÿà¦ªà¦¿à¦•

[Event Sourcing & CQRS â†’](./03-event-sourcing-cqrs.md)
