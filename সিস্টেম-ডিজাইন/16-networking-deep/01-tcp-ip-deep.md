# TCP/IP Deep Dive

## ğŸ¯ TCP Connection

### Three-Way Handshake
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 TCP Three-Way Handshake                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   Client                                        Server          â”‚
â”‚     â”‚                                             â”‚             â”‚
â”‚     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SYN (seq=x) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚             â”‚
â”‚     â”‚          "I want to connect"                â”‚             â”‚
â”‚     â”‚                                             â”‚             â”‚
â”‚     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SYN-ACK (seq=y, ack=x+1) â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚
â”‚     â”‚         "OK, I acknowledge"                 â”‚             â”‚
â”‚     â”‚                                             â”‚             â”‚
â”‚     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ACK (ack=y+1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚             â”‚
â”‚     â”‚          "Got it, let's go"                 â”‚             â”‚
â”‚     â”‚                                             â”‚             â”‚
â”‚     â”‚â•â•â•â•â•â•â•â•â•â•â• Connection Established â•â•â•â•â•â•â•â•â•â•â”‚             â”‚
â”‚                                                                 â”‚
â”‚  Time: ~1 RTT (Round Trip Time)                                â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Connection Termination
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 TCP Connection Termination                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   Client                                        Server          â”‚
â”‚     â”‚                                             â”‚             â”‚
â”‚     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ FIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚             â”‚
â”‚     â”‚          "I'm done sending"                 â”‚             â”‚
â”‚     â”‚                                             â”‚             â”‚
â”‚     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚
â”‚     â”‚          "OK, got it"                       â”‚             â”‚
â”‚     â”‚                                             â”‚             â”‚
â”‚     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ FIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚
â”‚     â”‚          "I'm also done"                    â”‚             â”‚
â”‚     â”‚                                             â”‚             â”‚
â”‚     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚             â”‚
â”‚     â”‚          "Goodbye"                          â”‚             â”‚
â”‚     â”‚                                             â”‚             â”‚
â”‚     â”‚â•â•â•â•â•â•â•â•â•â•â• Connection Closed â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚             â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š TCP Congestion Control

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Congestion Control                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Congestion Window (cwnd)                                      â”‚
â”‚                                                                 â”‚
â”‚    ^                                                            â”‚
â”‚    â”‚              Slow Start    Congestion       Recovery      â”‚
â”‚    â”‚                 â†“          Avoidance                      â”‚
â”‚    â”‚                              â†“                            â”‚
â”‚  c â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  w â”‚              /\   /             â”‚                         â”‚
â”‚  n â”‚            /    \/              â”‚                         â”‚
â”‚  d â”‚          /                      â”‚                         â”‚
â”‚    â”‚        /                        â”‚                         â”‚
â”‚    â”‚      /   â† Slow start           â”‚ â† Packet loss          â”‚
â”‚    â”‚    /      (exponential)         â”‚   (window halved)      â”‚
â”‚    â”‚  /                              â”‚                         â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Time           â”‚
â”‚                                                                 â”‚
â”‚  Slow Start: cwnd doubles each RTT                             â”‚
â”‚  Congestion Avoidance: cwnd += 1/cwnd per ACK (linear)        â”‚
â”‚  Fast Recovery: cwnd = ssthresh + 3                           â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ TCP Tuning Parameters

```
# Linux TCP tuning

# Maximum receive buffer
net.core.rmem_max = 16777216

# Maximum send buffer
net.core.wmem_max = 16777216

# TCP receive buffer (min, default, max)
net.ipv4.tcp_rmem = 4096 87380 16777216

# TCP send buffer
net.ipv4.tcp_wmem = 4096 65536 16777216

# TCP Fast Open
net.ipv4.tcp_fastopen = 3

# Keep-alive settings
net.ipv4.tcp_keepalive_time = 300
net.ipv4.tcp_keepalive_intvl = 30
net.ipv4.tcp_keepalive_probes = 5
```

## ğŸ’¡ Performance Considerations

```
Latency Issues:
â”œâ”€â”€ TCP handshake: 1 RTT
â”œâ”€â”€ TLS handshake: 1-2 RTT
â”œâ”€â”€ Total: 2-3 RTT before first byte
â””â”€â”€ Solutions: TCP Fast Open, TLS 1.3, Connection pooling

Bandwidth Issues:
â”œâ”€â”€ Slow start limits initial throughput
â”œâ”€â”€ Small window = underutilization
â””â”€â”€ Solutions: TCP tuning, larger initial cwnd

Head-of-line Blocking:
â”œâ”€â”€ Single TCP stream
â”œâ”€â”€ One lost packet blocks all
â””â”€â”€ Solution: HTTP/2 streams, QUIC
```

## ğŸ“š à¦ªà¦°à¦¬à¦°à§à¦¤à§€ à¦Ÿà¦ªà¦¿à¦•

[DNS Architecture â†’](./02-dns-architecture.md)
