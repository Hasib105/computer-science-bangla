# ржорзЗрж╕рзЗржЬ ржХрж┐ржЙ ржмрзЗрж╕рж┐ржХ (Message Queue Basics)

## ЁЯОп ржорзЗрж╕рзЗржЬ ржХрж┐ржЙ ржХрж┐?

**ржорзЗрж╕рзЗржЬ ржХрж┐ржЙ** рж╣рж▓рзЛ рж╕рж┐рж╕рзНржЯрзЗржо ржХржорзНржкрзЛржирзЗржирзНржЯржЧрзБрж▓рзЛрж░ ржоржзрзНржпрзЗ ржЕрзНржпрж╛рж╕рж┐ржиржХрзНрж░рзЛржирж╛рж╕ ржХржорж┐ржЙржирж┐ржХрзЗрж╢ржирзЗрж░ ржЬржирзНржп ржПржХржЯрж┐ ржоржзрзНржпрж╕рзНржерждрж╛ржХрж╛рж░рзАред

```
рж╕рж┐ржиржХрзНрж░рзЛржирж╛рж╕ (рж╕рж░рж╛рж╕рж░рж┐):
Service A тЖТ Service B тЖТ Response тЖТ Service A
            (ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рждрзЗ рж╣ржпрж╝)

ржЕрзНржпрж╛рж╕рж┐ржиржХрзНрж░рзЛржирж╛рж╕ (ржХрж┐ржЙ ржжрж┐ржпрж╝рзЗ):
Service A тЖТ Queue тЖТ Done!
                тЖУ
           Service B (ржкрж░рзЗ ржкрзНрж░рж╕рзЗрж╕ ржХрж░рзЗ)
```

## ЁЯУК ржХрзЗржи ржорзЗрж╕рзЗржЬ ржХрж┐ржЙ ржжрж░ржХрж╛рж░?

### рзз. Decoupling
```
Tightly Coupled:
тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР    тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР    тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ Order    тФВ тФАтФАтФАтЖТтФВ Payment  тФВ тФАтФАтФАтЖТтФВ Shipping тФВ
тФВ Service  тФВ    тФВ Service  тФВ    тФВ Service  тФВ
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ    тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ    тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ
  (ржПржХржЯрж╛ ржлрзЗржЗрж▓ = рж╕ржм ржлрзЗржЗрж▓)

Loosely Coupled:
тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР    тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР    тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ Order    тФВ тФАтФАтФАтЖТтФВ  Queue  тФВтЖРтФАтФАтЖТтФВ Payment  тФВ
тФВ Service  тФВ    тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ    тФВ Service  тФВ
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ         тЖС         тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ
                     тФВ         тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
                     тФФтФАтФАтФАтФАтФАтФАтФАтФАтЖТтФВ Shipping тФВ
                               тФВ Service  тФВ
                               тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ
  (рж╕рзНржмрж╛ржзрзАржиржнрж╛ржмрзЗ ржХрж╛ржЬ ржХрж░рзЗ)
```

### рзи. Async Processing
```
рж╕рж┐ржиржХрзНрж░рзЛржирж╛рж╕:
User тЖТ Order тЖТ Payment тЖТ Email тЖТ SMS тЖТ Response
              тЖСтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтЖС
              (рзл рж╕рзЗржХрзЗржирзНржб ржЕржкрзЗржХрзНрж╖рж╛)

ржЕрзНржпрж╛рж╕рж┐ржиржХрзНрж░рзЛржирж╛рж╕:
User тЖТ Order тЖТ Queue тЖТ Response (рждрж╛рзОржХрзНрж╖ржгрж┐ржХ)
                 тЖУ
        тФМтФАтФАтФАтФАтФАтФАтФАтФАтФ┤тФАтФАтФАтФАтФАтФАтФАтФАтФР
        тЖУ        тЖУ        тЖУ
    Payment   Email     SMS
   (ржкрж░рзЗ ржкрзНрж░рж╕рзЗрж╕ рж╣ржпрж╝)
```

### рзй. Load Leveling
```
Traffic Spike:
тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ                                         тФВ
тФВ    тЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИ                             тФВ
тФВ    тЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИ                             тФВ
тФВ    тЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИ                    тФВ
тФВ    тЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИ              тФВ
тФВтФАтФАтФАтФАтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтЦИтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФВ
тФВ    Spike! (рззрзжрзжрзж req/s)                 тФВ
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ

ржХрж┐ржЙ ржжрж┐ржпрж╝рзЗ рж╕рж╛ржорж▓рж╛ржирзЛ:
                    тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
Spike тЖТ тЖТ тЖТ тЖТ тЖТ тЖТ тФВ  Queue  тФВ тЖТ тЖТ Consumer (рззрзжрзж req/s)
                    тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ
                    (Buffer рж╣рж┐рж╕рзЗржмрзЗ ржХрж╛ржЬ ржХрж░рзЗ)
```

### рзк. Reliability
```
ржХрж┐ржЙ ржЫрж╛ржбрж╝рж╛:
Service A тЖТ Service B (ржбрж╛ржЙржи!)
            тЖУ
        рж░рж┐ржХрзЛржпрж╝рзЗрж╕рзНржЯ рж╣рж╛рж░рж┐ржпрж╝рзЗ ржЧрзЗрж▓!

ржХрж┐ржЙ рж╕рж╣:
Service A тЖТ Queue тЖТ Service B (ржбрж╛ржЙржи)
            тФВ
         (ржорзЗрж╕рзЗржЬ рж╕рзЗржн ржерж╛ржХрзЗ)
            тФВ
            тЖУ
        Service B (ржкрж░рзЗ ржЖржмрж╛рж░ ржЪрж╛рж▓рзБ)
            тЖУ
        ржорзЗрж╕рзЗржЬ ржкрзНрж░рж╕рзЗрж╕ рж╣рж▓рзЛ тЬУ
```

## ЁЯФД ржорзЗрж╕рзЗржЬрж┐ржВ ржкрзНржпрж╛ржЯрж╛рж░рзНржи

### рзз. Point-to-Point (P2P)
```
ржПржХржЯрж┐ ржорзЗрж╕рзЗржЬ ржПржХржЬржи ржХржиржЬрж┐ржЙржорж╛рж░ ржкрж╛ржпрж╝ред

Producer тЖТ Queue тЖТ Consumer

тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР    тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР    тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ Producer тФВ тФАтЖТ тФВ  Queue  тФВ тФАтЖТ тФВ Consumer тФВ
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ    тФВ [1,2,3] тФВ    тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ
                тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ

Consumer ржкрзЗрж▓рзЛ: 1, 2, 3
```

### рзи. Publish/Subscribe
```
ржПржХржЯрж┐ ржорзЗрж╕рзЗржЬ рж╕ржм рж╕рж╛ржмрж╕рзНржХрзНрж░рж╛ржЗржмрж╛рж░ ржкрж╛ржпрж╝ред

                              тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
                         тФМтФАтФАтФАтЖТтФВSubscriber AтФВ
тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР    тФМтФАтФАтФАтФАтФАтФАтФАтФРтФВ    тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ
тФВPublisher тФВ тФАтЖТ тФВ Topic тФЬтФд    тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ    тФФтФАтФАтФАтФАтФАтФАтФАтФШтФЬтФАтФАтФАтЖТтФВSubscriber BтФВ
                         тФВ    тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ
                         тФВ    тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
                         тФФтФАтФАтФАтЖТтФВSubscriber CтФВ
                              тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ

рж╕ржмрж╛ржЗ ржорзЗрж╕рзЗржЬ ржкрж╛ржпрж╝
```

### рзй. Request-Reply
```
Producer                Queue               Consumer
   тФВ                      тФВ                    тФВ
   тФВтФАтФАтФА Request тФАтФАтФАтФАтФАтФАтФАтФАтФАтЖТтФВ                    тФВ
   тФВ                      тФВтФАтФАтФА Request тФАтФАтФАтФАтФАтФАтФАтЖТтФВ
   тФВ                      тФВтЖРтФАтФА Reply тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФВ
   тФВтЖРтФАтФА Reply тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФВ                    тФВ
   тФВ                      тФВ                    тФВ
```

## ЁЯПЧя╕П ржорзЗрж╕рзЗржЬ ржХрж┐ржЙ ржЖрж░рзНржХрж┐ржЯрзЗржХржЪрж╛рж░

```
тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ                    Message Queue System                      тФВ
тФЬтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФд
тФВ                                                             тФВ
тФВ  тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР    тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР  тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР тФВ
тФВ  тФВ Producer тФВтФАтФАтФАтЖТтФВ      Message Broker    тФВтФАтЖТтФВ Consumer тФВ тФВ
тФВ  тФВ          тФВ    тФВ  тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР тФВ  тФВ          тФВ тФВ
тФВ  тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ    тФВ  тФВ  Queue/Topic     тФВ тФВ  тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ тФВ
тФВ                  тФВ  тФВ тФМтФАтФАтФАтФмтФАтФАтФАтФмтФАтФАтФАтФмтФАтФАтФАтФРтФВ тФВ               тФВ
тФВ  тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР    тФВ  тФВ тФВ 1 тФВ 2 тФВ 3 тФВ 4 тФВтФВ тФВ  тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР тФВ
тФВ  тФВ Producer тФВтФАтФАтФАтЖТтФВ  тФВ тФФтФАтФАтФАтФ┤тФАтФАтФАтФ┤тФАтФАтФАтФ┤тФАтФАтФАтФШтФВ тФВтФАтЖТтФВ Consumer тФВ тФВ
тФВ  тФВ          тФВ    тФВ  тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ тФВ  тФВ          тФВ тФВ
тФВ  тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ    тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ  тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ тФВ
тФВ                                                             тФВ
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ

Components:
- Producer: ржорзЗрж╕рзЗржЬ рждрзИрж░рж┐ ржХрж░рзЗ
- Broker: ржорзЗрж╕рзЗржЬ рж╕рзНржЯрзЛрж░ ржУ ржбрзЗрж▓рж┐ржнрж╛рж░ ржХрж░рзЗ
- Queue/Topic: ржорзЗрж╕рзЗржЬ рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рзЗ
- Consumer: ржорзЗрж╕рзЗржЬ ржкрзНрж░рж╕рзЗрж╕ ржХрж░рзЗ
```

## ЁЯУи ржорзЗрж╕рзЗржЬ ржбрзЗрж▓рж┐ржнрж╛рж░рж┐ ржЧрзНржпрж╛рж░рж╛ржирзНржЯрж┐

### рзз. At Most Once
```
ржорзЗрж╕рзЗржЬ рж╣ржпрж╝рждрзЛ рж╣рж╛рж░рж┐ржпрж╝рзЗ ржпрзЗрждрзЗ ржкрж╛рж░рзЗ, ржХрж┐ржирзНрждрзБ ржбрзБржкрзНрж▓рж┐ржХрзЗржЯ рж╣ржмрзЗ ржирж╛ред

Producer тЖТ Broker тЖТ Consumer
           тЖУ
      (ACK ржирж╛ ржкрзЗрж▓рзЗ retry ржирзЗржЗ)

Use Case: Metrics, Logs (ржХрж┐ржЫрзБ рж╣рж╛рж░рж╛рж▓рзЗ рж╕ржорж╕рзНржпрж╛ ржирзЗржЗ)
```

### рзи. At Least Once
```
ржорзЗрж╕рзЗржЬ ржбрзЗрж▓рж┐ржнрж╛рж░ рж╣ржмрзЗржЗ, ржХрж┐ржирзНрждрзБ ржбрзБржкрзНрж▓рж┐ржХрзЗржЯ рж╣рждрзЗ ржкрж╛рж░рзЗред

Producer тЖТ Broker тЖТ Consumer
           тЖУ           тЖУ
      (ACK ржирж╛ ржкрзЗрж▓рзЗ) (ACK ржкрж╛ржарж╛ржпрж╝)
           тЖУ
      (Retry ржХрж░рзЗ)

Use Case: Order processing (ржбрзБржкрзНрж▓рж┐ржХрзЗржЯ рж╣рзНржпрж╛ржирзНржбрзЗрж▓ ржХрж░рждрзЗ рж╣ржмрзЗ)
```

### рзй. Exactly Once
```
ржорзЗрж╕рзЗржЬ ржарж┐ржХ ржПржХржмрж╛рж░ ржбрзЗрж▓рж┐ржнрж╛рж░ рж╣ржмрзЗред

Producer тЖТ Broker тЖТ Consumer
    тЖУ         тЖУ         тЖУ
(Transaction) (Dedup) (Idempotent)

рж╕ржмржЪрзЗржпрж╝рзЗ ржХржарж┐ржи, рж╕ржмржЪрзЗржпрж╝рзЗ ржЦрж░ржЪрж╕рж╛ржкрзЗржХрзНрж╖ред
Use Case: Payment processing
```

## ЁЯТб Use Cases

### рзз. Email/SMS ржкрж╛ржарж╛ржирзЛ
```python
# Order рж╕рж╛рж░рзНржнрж┐рж╕рзЗ
def create_order(order_data):
    order = save_to_db(order_data)
    
    # Email queue-рждрзЗ ржкрж╛ржарж╛ржУ
    queue.publish("email_queue", {
        "type": "order_confirmation",
        "email": order.user_email,
        "order_id": order.id
    })
    
    return order  # ржЗржЙржЬрж╛рж░ржХрзЗ рждрж╛ржбрж╝рж╛рждрж╛ржбрж╝рж┐ рж░рзЗрж╕ржкржирзНрж╕ ржжрж╛ржУ

# Email Worker (ржЖрж▓рж╛ржжрж╛ ржкрзНрж░рж╕рзЗрж╕)
def email_worker():
    while True:
        message = queue.consume("email_queue")
        send_email(message)
```

### рзи. Image Processing
```
User uploads image
       тЖУ
Save raw image тЖТ Queue тЖТ Return success
                   тЖУ
            Image Worker
                   тЖУ
    тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФ╝тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
    тЖУ              тЖУ              тЖУ
 Thumbnail     Compress       Watermark
    тЖУ              тЖУ              тЖУ
 Save to S3    Save to S3    Save to S3
```

### рзй. Event-Driven Architecture
```
User registers
       тЖУ
тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ "user.registered"тФВ
тФВ      Event       тФВ
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФмтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ
         тФВ
   тФМтФАтФАтФАтФАтФАтФ┤тФАтФАтФАтФАтФАтФР
   тФВ   Queue   тФВ
   тФФтФАтФАтФАтФАтФАтФмтФАтФАтФАтФАтФАтФШ
         тФВ
    тФМтФАтФАтФАтФАтФ┤тФАтФАтФАтФАтФРтФАтФАтФАтФАтФАтФАтФАтФАтФРтФАтФАтФАтФАтФАтФАтФАтФАтФР
    тЖУ         тЖУ        тЖУ        тЖУ
 Email    Analytics  Referral  Welcome
Service   Service    Service    Gift
```

## тЬЕ ржорзЗрж╕рзЗржЬ ржХрж┐ржЙ ржЪрзЗржХрж▓рж┐рж╕рзНржЯ

- [ ] рж╕ржарж┐ржХ ржбрзЗрж▓рж┐ржнрж╛рж░рж┐ ржЧрзНржпрж╛рж░рж╛ржирзНржЯрж┐ ржирж┐рж░рзНржмрж╛ржЪржи
- [ ] Dead Letter Queue рж╕рзЗржЯржЖржк
- [ ] Retry strategy
- [ ] Idempotent consumers
- [ ] Monitoring ржУ alerting
- [ ] Message TTL рж╕рзЗржЯ ржХрж░рж╛
- [ ] Consumer scaling strategy

## ЁЯУЪ ржкрж░ржмрж░рзНрждрзА ржЯржкрж┐ржХ

[Pub/Sub ржкрзНржпрж╛ржЯрж╛рж░рзНржи тЖТ](./02-pub-sub.md)
