# ржХрзНржпрж╛рж╢ ржЗржиржнрзНржпрж╛рж▓рж┐ржбрзЗрж╢ржи (Cache Invalidation)

## ЁЯОп ржХрзНржпрж╛рж╢ ржЗржиржнрзНржпрж╛рж▓рж┐ржбрзЗрж╢ржи ржХрж┐?

**ржХрзНржпрж╛рж╢ ржЗржиржнрзНржпрж╛рж▓рж┐ржбрзЗрж╢ржи** рж╣рж▓рзЛ ржкрзБрж░рж╛рждржи ржмрж╛ ржнрзБрж▓ ржХрзНржпрж╛рж╢ржб ржбрж╛ржЯрж╛ рж╕рж░рж┐ржпрж╝рзЗ ржлрзЗрж▓рж╛ ржмрж╛ ржЖржкржбрзЗржЯ ржХрж░рж╛ред

```
"There are only two hard things in Computer Science: 
 cache invalidation and naming things."
                                    тАФ Phil Karlton
```

## тЪая╕П рж╕ржорж╕рзНржпрж╛: Stale Data

```
t=0: DB: user.name = "ржЖрж╣ржорзЗржж"
     Cache: user.name = "ржЖрж╣ржорзЗржж"

t=1: Admin DB-рждрзЗ ржЖржкржбрзЗржЯ ржХрж░рзЗ: user.name = "рж░рж╣рж┐ржо"
     DB: user.name = "рж░рж╣рж┐ржо"
     Cache: user.name = "ржЖрж╣ржорзЗржж" тЖР ржкрзБрж░рж╛рждржи!

t=2: User reads from cache
     ржжрзЗржЦрзЗ: "ржЖрж╣ржорзЗржж" тЖР ржнрзБрж▓!
```

## ЁЯУК ржЗржиржнрзНржпрж╛рж▓рж┐ржбрзЗрж╢ржи рж╕рзНржЯрзНрж░рзНржпрж╛ржЯрзЗржЬрж┐

### рзз. TTL (Time To Live)
```
ржирж┐рж░рзНржжрж┐рж╖рзНржЯ рж╕ржоржпрж╝ ржкрж░ ржЕржЯрзЛ-ржПржХрзНрж╕ржкрж╛ржпрж╝рж╛рж░ред

cache.set("user:123", data, ttl=3600)  # рзз ржШржирзНржЯрж╛ ржкрж░ ржорзБржЫрзЗ ржпрж╛ржмрзЗ

рж╕рзБржмрж┐ржзрж╛:
тЬУ рж╕рж┐ржорзНржкрж▓
тЬУ ржЕржЯрзЛржорзЗржЯрж┐ржХ
тЬУ ржорзЗржорж░рж┐ ржкрж░рж┐рж╖рзНржХрж╛рж░ рж╣ржпрж╝

ржЕрж╕рзБржмрж┐ржзрж╛:
тЬЧ TTL ржПрж░ ржоржзрзНржпрзЗ рж╕рзНржЯрзЗрж▓ ржбрж╛ржЯрж╛ ржерж╛ржХрждрзЗ ржкрж╛рж░рзЗ
тЬЧ рж╕ржарж┐ржХ TTL ржмрзЗржЫрзЗ ржирзЗржУржпрж╝рж╛ ржХржарж┐ржи
```

### TTL ржирж┐рж░рзНржмрж╛ржЪржи ржЧрж╛ржЗржб
```
ржбрж╛ржЯрж╛ ржЯрж╛ржЗржк              рж╕рж╛ржЬрзЗрж╕рзНржЯрзЗржб TTL
тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
User Session           рззрзл ржорж┐ржирж┐ржЯ - рзирзк ржШржирзНржЯрж╛
User Profile           рзз ржШржирзНржЯрж╛ - рзирзк ржШржирзНржЯрж╛
Product Catalog        рзз ржШржирзНржЯрж╛ - рзз рж╕ржкрзНрждрж╛рж╣
Configuration          рзл ржорж┐ржирж┐ржЯ - рзз ржШржирзНржЯрж╛
API Response           рзз ржорж┐ржирж┐ржЯ - рзз ржШржирзНржЯрж╛
Static Assets          рзз рж╕ржкрзНрждрж╛рж╣ - рзз ржмржЫрж░
```

### рзи. Explicit Invalidation
```python
# ржбрж╛ржЯрж╛ ржЖржкржбрзЗржЯ рж╣рж▓рзЗ рж╕рж╛ржерзЗ рж╕рж╛ржерзЗ ржХрзНржпрж╛рж╢ ржбрж┐рж▓рж┐ржЯ

def update_user(user_id, data):
    # DB ржЖржкржбрзЗржЯ
    db.update("UPDATE users SET name = ? WHERE id = ?", 
              data['name'], user_id)
    
    # ржХрзНржпрж╛рж╢ ржЗржиржнрзНржпрж╛рж▓рж┐ржбрзЗржЯ
    cache.delete(f"user:{user_id}")
    
    # ржЕржержмрж╛ ржирждрзБржи ржнрзНржпрж╛рж▓рзБ рж╕рзЗржЯ
    # cache.set(f"user:{user_id}", data)

рж╕рзБржмрж┐ржзрж╛:
тЬУ рждрж╛рзОржХрзНрж╖ржгрж┐ржХ ржЖржкржбрзЗржЯ
тЬУ ржХрзЛржирзЛ рж╕рзНржЯрзЗрж▓ ржбрж╛ржЯрж╛ ржирзЗржЗ

ржЕрж╕рзБржмрж┐ржзрж╛:
тЬЧ ржорзНржпрж╛ржирзБржпрж╝рж╛рж▓ ржХрзЛржб рж▓рж┐ржЦрждрзЗ рж╣ржпрж╝
тЬЧ ржорж┐рж╕ ржХрж░рж╛рж░ рж╕ржорзНржнрж╛ржмржирж╛
```

### рзй. Event-Based Invalidation
```
                    тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
                    тФВ  Message     тФВ
                    тФВ  Queue       тФВ
                    тФФтФАтФАтФАтФАтФАтФАтФмтФАтФАтФАтФАтФАтФАтФАтФШ
                           тФВ
        тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФ╝тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
        тЖУ                  тЖУ                  тЖУ
   тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР       тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР       тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
   тФВ Service тФВ       тФВ  Cache  тФВ       тФВ Search  тФВ
   тФВ    A    тФВ       тФВ Service тФВ       тФВ Service тФВ
   тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ       тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ       тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ

DB ржкрж░рж┐ржмрж░рзНрждржи рж╣рж▓рзЗ:
1. Event publish ржХрж░рзЗ (user.updated)
2. Cache service subscribe ржХрж░рзЗ
3. Cache invalidate ржХрж░рзЗ

ржЙржжрж╛рж╣рж░ржг:
- Kafka
- RabbitMQ
- Redis Pub/Sub
```

### рзк. Version-Based Invalidation
```python
# ржХрзНржпрж╛рж╢ ржХрзА-рждрзЗ ржнрж╛рж░рзНрж╕ржи рж░рж╛ржЦрж╛

current_version = cache.get("user:version") or 1
cache_key = f"user:{user_id}:v{current_version}"

def update_user(user_id, data):
    db.update(...)
    
    # ржнрж╛рж░рзНрж╕ржи ржмрж╛ржбрж╝рж╛ржирзЛ
    cache.incr("user:version")
    # ржкрзБрж░рж╛рждржи ржХрзНржпрж╛рж╢ ржЖрж░ ржорзНржпрж╛ржЪ ржХрж░ржмрзЗ ржирж╛

рж╕рзБржмрж┐ржзрж╛:
тЬУ рж╕ржм ржХрзНржпрж╛рж╢ ржПржХрж╕рж╛ржерзЗ ржЗржиржнрзНржпрж╛рж▓рж┐ржбрзЗржЯ
тЬУ рж╕рж┐ржорзНржкрж▓ рж▓ржЬрж┐ржХ
```

### рзл. Tag-Based Invalidation
```python
# ржЯрзНржпрж╛ржЧ ржжрж┐ржпрж╝рзЗ ржЧрзНрж░рзБржк ржХрж░рж╛

cache.set("user:123", data, tags=["users", "premium"])
cache.set("user:456", data, tags=["users", "free"])

# рж╕ржм users ржХрзНржпрж╛рж╢ ржХрзНрж▓рж┐ржпрж╝рж╛рж░
cache.invalidate_by_tag("users")

# рж╢рзБржзрзБ premium users ржХрзНрж▓рж┐ржпрж╝рж╛рж░
cache.invalidate_by_tag("premium")
```

## ЁЯФД ржЗржиржнрзНржпрж╛рж▓рж┐ржбрзЗрж╢ржи ржкрзНржпрж╛ржЯрж╛рж░рзНржи

### рзз. Cache-Aside Invalidation
```python
def update_user(user_id, data):
    # DB ржЖржкржбрзЗржЯ
    db.update(user_id, data)
    
    # ржХрзНржпрж╛рж╢ ржбрж┐рж▓рж┐ржЯ
    cache.delete(f"user:{user_id}")
    
    # ржкрж░ржмрж░рзНрждрзА рж░рж┐ржбрзЗ ржХрзНржпрж╛рж╢ ржкржкрзБрж▓рзЗржЯ рж╣ржмрзЗ

ржХрзНрж░ржо ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг:
тЬУ DB тЖТ Cache Delete (рж╕ржарж┐ржХ)
тЬЧ Cache Delete тЖТ DB (ржнрзБрж▓ - рж░рзЗрж╕ ржХржирзНржбрж┐рж╢ржи)
```

### рзи. Write-Through Invalidation
```python
def update_user(user_id, data):
    # ржПржХрж╕рж╛ржерзЗ ржжрзБржЗ ржЬрж╛ржпрж╝ржЧрж╛ржпрж╝
    db.update(user_id, data)
    cache.set(f"user:{user_id}", data)

рж╕рзБржмрж┐ржзрж╛:
тЬУ ржХрзНржпрж╛рж╢ рж╕ржмрж╕ржоржпрж╝ ржЖржкржбрзЗржЯрзЗржб
```

### рзй. Pub/Sub Invalidation
```python
# Publisher (ржпрзЗ ржЖржкржбрзЗржЯ ржХрж░рзЗ)
def update_user(user_id, data):
    db.update(user_id, data)
    redis.publish("cache:invalidate", {
        "type": "user",
        "id": user_id
    })

# Subscriber (ржпрзЗ ржХрзНржпрж╛рж╢ ржорзНржпрж╛ржирзЗржЬ ржХрж░рзЗ)
def on_message(message):
    if message['type'] == 'user':
        cache.delete(f"user:{message['id']}")

# ржЪрж╛рж▓рзБ ржерж╛ржХрж╛ ржжрж░ржХрж╛рж░
redis.subscribe("cache:invalidate", on_message)
```

## тЪб рж░рзЗрж╕ ржХржирзНржбрж┐рж╢ржи рж╕ржорж╕рзНржпрж╛

### рж╕ржорж╕рзНржпрж╛
```
Thread 1                    Thread 2
тФАтФАтФАтФАтФАтФАтФАтФАтФА                   тФАтФАтФАтФАтФАтФАтФАтФАтФА
Read from DB (v1)           
                            Update DB (v2)
                            Delete Cache
Set Cache (v1) тЖР ржкрзБрж░рж╛рждржи!

ржХрзНржпрж╛рж╢рзЗ ржкрзБрж░рж╛рждржи v1 ржЖржЫрзЗ, DB-рждрзЗ ржирждрзБржи v2
```

### рж╕ржорж╛ржзрж╛ржи

#### рзз. Delayed Deletion
```python
def update_user(user_id, data):
    db.update(user_id, data)
    cache.delete(f"user:{user_id}")
    
    # ржХрж┐ржЫрзБ рж╕ржоржпрж╝ ржкрж░ ржЖржмрж╛рж░ ржбрж┐рж▓рж┐ржЯ (рж░рзЗрж╕ ржХржирзНржбрж┐рж╢ржи ржХрзНржпрж╛ржЪ ржХрж░рждрзЗ)
    schedule_delete(f"user:{user_id}", delay=500)  # 500ms ржкрж░
```

#### рзи. Locking
```python
def update_user(user_id, data):
    lock = acquire_lock(f"user:{user_id}")
    try:
        db.update(user_id, data)
        cache.delete(f"user:{user_id}")
    finally:
        release_lock(lock)
```

#### рзй. Version Checking
```python
def set_cache_with_version(key, data, version):
    current = cache.get(f"{key}:version")
    if current is None or version > current:
        cache.set(key, data)
        cache.set(f"{key}:version", version)
```

## ЁЯУК ржЗржиржнрзНржпрж╛рж▓рж┐ржбрзЗрж╢ржи рж╕рзНржХрзЛржк

### рзз. Single Key
```python
cache.delete("user:123")
```

### рзи. Pattern-Based
```python
# Redis SCAN + DELETE
for key in cache.scan_iter("user:*"):
    cache.delete(key)
```

### рзй. Namespace/Prefix
```python
# Redis FLUSHDB (рж╕ржм ржбрж┐рж▓рж┐ржЯ)
# ржмрж╛ namespace change ржХрж░рж╛

old: "v1:user:123"
new: "v2:user:123"
```

### рзк. Full Cache Flush
```python
cache.flushall()  # рж╕ржм ржХрзНржпрж╛рж╢ ржХрзНрж▓рж┐ржпрж╝рж╛рж░

рж╕рждрж░рзНржХрждрж╛: рж╢рзБржзрзБ ржЬрж░рзБрж░рж┐ ржЕржмрж╕рзНржерж╛ржпрж╝!
```

## ЁЯТб ржмрзЗрж╕рзНржЯ ржкрзНрж░рзНржпрж╛ржХрзНржЯрж┐рж╕

```
рзз. рж╕ржмрж╕ржоржпрж╝ TTL рж░рж╛ржЦрзБржи
   - ржЗржиржнрзНржпрж╛рж▓рж┐ржбрзЗрж╢ржи ржорж┐рж╕ рж╣рж▓рзЗржУ ржПржХ рж╕ржоржпрж╝ ржПржХрзНрж╕ржкрж╛ржпрж╝рж╛рж░ рж╣ржмрзЗ

рзи. Write-ржП ржХрзНржпрж╛рж╢ ржбрж┐рж▓рж┐ржЯ ржХрж░рзБржи, рж╕рзЗржЯ ржиржпрж╝
   - рж░рзЗрж╕ ржХржирзНржбрж┐рж╢ржи ржХржо рж╣ржпрж╝

рзй. Event-driven invalidation ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи
   - ржорж╛рж▓рзНржЯрж┐-рж╕рж╛рж░рзНржнрж┐рж╕ ржЖрж░рзНржХрж┐ржЯрзЗржХржЪрж╛рж░рзЗ

рзк. Monitoring рж░рж╛ржЦрзБржи
   - ржХрзНржпрж╛рж╢ рж╣рж┐ржЯ рж░рзЗржЯ
   - рж╕рзНржЯрзЗрж▓ ржбрж╛ржЯрж╛ ржбрж┐ржЯрзЗржХрж╢ржи

рзл. Fallback рж░рж╛ржЦрзБржи
   - ржХрзНржпрж╛рж╢ ржлрзЗржЗрж▓ рж╣рж▓рзЗ DB ржерзЗржХрзЗ ржкржбрж╝рж╛
```

## ЁЯУЪ ржкрж░ржмрж░рзНрждрзА ржЯржкрж┐ржХ

[Redis ржУ Memcached тЖТ](./04-redis-memcached.md)
