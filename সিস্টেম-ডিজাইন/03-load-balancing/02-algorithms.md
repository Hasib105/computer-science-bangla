# рж▓рзЛржб ржмрзНржпрж╛рж▓рж╛ржирзНрж╕рж┐ржВ ржЕрзНржпрж╛рж▓ржЧрж░рж┐ржжржо (Load Balancing Algorithms)

## ЁЯОп ржмрж┐ржнрж┐ржирзНржи ржЕрзНржпрж╛рж▓ржЧрж░рж┐ржжржо

```
тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ              рж▓рзЛржб ржмрзНржпрж╛рж▓рж╛ржирзНрж╕рж┐ржВ ржЕрзНржпрж╛рж▓ржЧрж░рж┐ржжржо                   тФВ
тФЬтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФд
тФВ                                                          тФВ
тФВ  рж╕рзНржЯрзНржпрж╛ржЯрж┐ржХ ржЕрзНржпрж╛рж▓ржЧрж░рж┐ржжржо:                                   тФВ
тФВ  тФЬтФАтФА Round Robin                                        тФВ
тФВ  тФЬтФАтФА Weighted Round Robin                               тФВ
тФВ  тФФтФАтФА IP Hash                                            тФВ
тФВ                                                          тФВ
тФВ  ржбрж╛ржпрж╝ржирж╛ржорж┐ржХ ржЕрзНржпрж╛рж▓ржЧрж░рж┐ржжржо:                                  тФВ
тФВ  тФЬтФАтФА Least Connections                                  тФВ
тФВ  тФЬтФАтФА Weighted Least Connections                         тФВ
тФВ  тФЬтФАтФА Least Response Time                                тФВ
тФВ  тФФтФАтФА Resource Based                                     тФВ
тФВ                                                          тФВ
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ
```

## ЁЯФД рзз. Round Robin

### ржХрж┐ржнрж╛ржмрзЗ ржХрж╛ржЬ ржХрж░рзЗ?
```
ржкрж░рзНржпрж╛ржпрж╝ржХрзНрж░ржорзЗ ржкрзНрж░рждрж┐ржЯрж┐ рж╕рж╛рж░рзНржнрж╛рж░рзЗ рж░рж┐ржХрзЛржпрж╝рзЗрж╕рзНржЯ ржкрж╛ржарж╛ржирзЛред

Request 1 тЖТ Server 1
Request 2 тЖТ Server 2
Request 3 тЖТ Server 3
Request 4 тЖТ Server 1 (ржЖржмрж╛рж░ рж╢рзБрж░рзБ)
Request 5 тЖТ Server 2
...

тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ           Round Robin                  тФВ
тФВ                                        тФВ
тФВ    тЖТ  тФМтФАтФАтФАтФР  тЖТ  тФМтФАтФАтФАтФР  тЖТ  тФМтФАтФАтФАтФР  тЖТ   тФВ
тФВ       тФВ 1 тФВ     тФВ 2 тФВ     тФВ 3 тФВ       тФВ
тФВ       тФФтФАтФАтФАтФШ     тФФтФАтФАтФАтФШ     тФФтФАтФАтФАтФШ       тФВ
тФВ          тЖС                    тФВ        тФВ
тФВ          тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ        тФВ
тФВ                                        тФВ
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ
```

### рж╕рзБржмрж┐ржзрж╛ ржУ ржЕрж╕рзБржмрж┐ржзрж╛
```
рж╕рзБржмрж┐ржзрж╛:
тЬУ рж╕рж┐ржорзНржкрж▓ ржЗржоржкрзНрж▓рж┐ржорзЗржирзНржЯрзЗрж╢ржи
тЬУ рж╕ржорж╛ржи рж╕рж╛рж░рзНржнрж╛рж░рзЗрж░ ржЬржирзНржп ржнрж╛рж▓рзЛ
тЬУ ржХрзЛржирзЛ рж╕рзНржЯрзЗржЯ рж░рж╛ржЦрждрзЗ рж╣ржпрж╝ ржирж╛

ржЕрж╕рзБржмрж┐ржзрж╛:
тЬЧ рж╕рж╛рж░рзНржнрж╛рж░ ржХрзНрж╖ржорждрж╛ ржмрж┐ржмрзЗржЪржирж╛ ржХрж░рзЗ ржирж╛
тЬЧ ржмрж░рзНрждржорж╛ржи рж▓рзЛржб ржмрж┐ржмрзЗржЪржирж╛ ржХрж░рзЗ ржирж╛
тЬЧ рж▓ржВ рж░рж┐ржХрзЛржпрж╝рзЗрж╕рзНржЯ рж╕ржорж╕рзНржпрж╛ рж╕рзГрж╖рзНржЯрж┐ ржХрж░рждрзЗ ржкрж╛рж░рзЗ
```

### Nginx ржХржиржлрж┐ржЧ
```nginx
upstream backend {
    server server1:8080;
    server server2:8080;
    server server3:8080;
}
```

## тЪЦя╕П рзи. Weighted Round Robin

### ржХрж┐ржнрж╛ржмрзЗ ржХрж╛ржЬ ржХрж░рзЗ?
```
рж╕рж╛рж░рзНржнрж╛рж░рзЗрж░ ржХрзНрж╖ржорждрж╛ ржЕржирзБржпрж╛ржпрж╝рзА ржУржпрж╝рзЗржЯ ржжрзЗржУржпрж╝рж╛ рж╣ржпрж╝ред

Server 1: weight = 5 (рж╢ржХрзНрждрж┐рж╢рж╛рж▓рзА)
Server 2: weight = 3 (ржорж╛ржЭрж╛рж░рж┐)
Server 3: weight = 2 (ржжрзБрж░рзНржмрж▓)

Request Distribution (ржкрзНрж░рждрж┐ рззрзж рж░рж┐ржХрзЛржпрж╝рзЗрж╕рзНржЯрзЗ):
Server 1: рзлржЯрж┐
Server 2: рзйржЯрж┐
Server 3: рзиржЯрж┐

тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ           Weighted Round Robin                         тФВ
тФВ                                                        тФВ
тФВ    тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР      тФМтФАтФАтФАтФАтФАтФАтФАтФР      тФМтФАтФАтФАтФАтФАтФР           тФВ
тФВ    тФВ Server1 тФВ      тФВServer2тФВ      тФВ S3  тФВ           тФВ
тФВ    тФВ W = 5   тФВ      тФВ W = 3 тФВ      тФВW = 2тФВ           тФВ
тФВ    тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ      тФФтФАтФАтФАтФАтФАтФАтФАтФШ      тФФтФАтФАтФАтФАтФАтФШ           тФВ
тФВ        тФВ               тФВ              тФВ               тФВ
тФВ    тЦУтЦУтЦУтЦУтЦУтЦУтЦУтЦУтЦУтЦУ     тЦУтЦУтЦУтЦУтЦУтЦУтЦУтЦУ      тЦУтЦУтЦУтЦУтЦУ               тФВ
тФВ    (50%)           (30%)         (20%)                тФВ
тФВ                                                        тФВ
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ
```

### Nginx ржХржиржлрж┐ржЧ
```nginx
upstream backend {
    server server1:8080 weight=5;
    server server2:8080 weight=3;
    server server3:8080 weight=2;
}
```

## ЁЯФЧ рзй. Least Connections

### ржХрж┐ржнрж╛ржмрзЗ ржХрж╛ржЬ ржХрж░рзЗ?
```
рж╕ржмржЪрзЗржпрж╝рзЗ ржХржо ржХрж╛ржирзЗржХрж╢ржи ржЖржЫрзЗ ржПржоржи рж╕рж╛рж░рзНржнрж╛рж░рзЗ ржкрж╛ржарж╛ржирзЛред

Current Connections:
Server 1: 45 connections
Server 2: 23 connections тЖР ржПржЦрж╛ржирзЗ ржкрж╛ржарж╛ржУ
Server 3: 67 connections

ржкрж░ржмрж░рзНрждрзА рж░рж┐ржХрзЛржпрж╝рзЗрж╕рзНржЯ:
Server 1: 45
Server 2: 24 (ржирждрзБржи)
Server 3: 67
```

### ржХржЦржи ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржмрзЗржи?
```
тЬУ рж░рж┐ржХрзЛржпрж╝рзЗрж╕рзНржЯ ржкрзНрж░рж╕рзЗрж╕рж┐ржВ рж╕ржоржпрж╝ ржнрж┐ржирзНржи рж╣рж▓рзЗ
тЬУ рж▓ржВ-рж▓рж┐ржнржб ржХрж╛ржирзЗржХрж╢ржи ржерж╛ржХрж▓рзЗ (WebSocket)
тЬУ ржнрзНржпрж╛рж░рж┐ржпрж╝рзЗржмрж▓ ржУржпрж╝рж╛рж░рзНржХрж▓рзЛржб

ржЙржжрж╛рж╣рж░ржг:
- ржнрж┐ржбрж┐ржУ рж╕рзНржЯрзНрж░рж┐ржорж┐ржВ
- ржЪрзНржпрж╛ржЯ ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржи
- рж░рж┐ржкрзЛрж░рзНржЯ ржЬрзЗржирж╛рж░рзЗрж╢ржи
```

### Nginx ржХржиржлрж┐ржЧ
```nginx
upstream backend {
    least_conn;
    server server1:8080;
    server server2:8080;
    server server3:8080;
}
```

### HAProxy ржХржиржлрж┐ржЧ
```haproxy
backend servers
    balance leastconn
    server server1 10.0.0.1:8080
    server server2 10.0.0.2:8080
    server server3 10.0.0.3:8080
```

## ЁЯУК рзк. Weighted Least Connections

```
Least Connections + Weight ржПржХрж╕рж╛ржерзЗ

Connection Calculation:
Score = Active Connections / Weight

Server 1: 50 connections, weight 5 тЖТ Score = 10
Server 2: 30 connections, weight 3 тЖТ Score = 10
Server 3: 15 connections, weight 2 тЖТ Score = 7.5 тЖР Winner!

рж╕ржмржЪрзЗржпрж╝рзЗ ржХржо рж╕рзНржХрзЛрж░ = рж╕рзЗржЗ рж╕рж╛рж░рзНржнрж╛рж░рзЗ ржкрж╛ржарж╛ржУ
```

## ЁЯПа рзл. IP Hash

### ржХрж┐ржнрж╛ржмрзЗ ржХрж╛ржЬ ржХрж░рзЗ?
```
ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯ IP-ржПрж░ рж╣рзНржпрж╛рж╢ ржжрж┐ржпрж╝рзЗ рж╕рж╛рж░рзНржнрж╛рж░ ржирж┐рж░рзНржмрж╛ржЪржиред

IP: 192.168.1.100
hash(192.168.1.100) = 12345
12345 % 3 = 0 тЖТ Server 1

ржПржХржЗ IP рж╕ржмрж╕ржоржпрж╝ ржПржХржЗ рж╕рж╛рж░рзНржнрж╛рж░рзЗ ржпрж╛ржмрзЗ!

тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ                    IP Hash                             тФВ
тФВ                                                        тФВ
тФВ  Client IP        Hash         Server                  тФВ
тФВ  тФАтФАтФАтФАтФАтФАтФАтФАтФА        тФАтФАтФАтФА         тФАтФАтФАтФАтФАтФА                  тФВ
тФВ  192.168.1.1  тЖТ  hash()%3=0 тЖТ Server 1               тФВ
тФВ  192.168.1.2  тЖТ  hash()%3=1 тЖТ Server 2               тФВ
тФВ  192.168.1.3  тЖТ  hash()%3=2 тЖТ Server 3               тФВ
тФВ  192.168.1.4  тЖТ  hash()%3=0 тЖТ Server 1               тФВ
тФВ                                                        тФВ
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ
```

### ржмрзНржпржмрж╣рж╛рж░
```
тЬУ рж╕рзЗрж╢ржи ржкрж╛рж░рзНрж╕рж┐рж╕рзНржЯрзЗржирзНрж╕ ржжрж░ржХрж╛рж░ рж╣рж▓рзЗ
тЬУ ржХрзНржпрж╛рж╢рж┐ржВ рж╕рж╛рж░рзНржнрж╛рж░рзЗ

рж╕рждрж░рзНржХрждрж╛:
тЬЧ NAT ржкрж┐ржЫржирзЗрж░ ржЗржЙржЬрж╛рж░ ржПржХржЗ IP ржжрзЗржЦрж╛ржпрж╝
тЬЧ ржЖржиржЗржнрзЗржи ржбрж┐рж╕рзНржЯрзНрж░рж┐ржмрж┐ржЙрж╢ржи рж╣рждрзЗ ржкрж╛рж░рзЗ
```

### Nginx ржХржиржлрж┐ржЧ
```nginx
upstream backend {
    ip_hash;
    server server1:8080;
    server server2:8080;
    server server3:8080;
}
```

## тП▒я╕П рзм. Least Response Time

### ржХрж┐ржнрж╛ржмрзЗ ржХрж╛ржЬ ржХрж░рзЗ?
```
рж╕ржмржЪрзЗржпрж╝рзЗ ржжрзНрж░рзБржд рж░рзЗрж╕ржкржирзНрж╕ ржжрзЗржпрж╝ ржПржоржи рж╕рж╛рж░рзНржнрж╛рж░рзЗ ржкрж╛ржарж╛ржирзЛред

Average Response Time:
Server 1: 45ms
Server 2: 23ms тЖР ржПржЦрж╛ржирзЗ ржкрж╛ржарж╛ржУ
Server 3: 67ms

Score = (Active Connections + 1) ├Ч Response Time
```

### Nginx ржХржиржлрж┐ржЧ (Plus/Commercial)
```nginx
upstream backend {
    least_time header;  # ржмрж╛ 'last_byte'
    server server1:8080;
    server server2:8080;
    server server3:8080;
}
```

## ЁЯО▓ рзн. Random

```
рж░тАНрзНржпрж╛ржирзНржбржорж▓рж┐ рж╕рж╛рж░рзНржнрж╛рж░ рж╕рж┐рж▓рзЗржХрзНржЯ ржХрж░рж╛ред

random() тЖТ Server X

рж╕рж┐ржорзНржкрж▓ ржХрж┐ржирзНрждрзБ ржмржбрж╝ рж╕рзНржХрзЗрж▓рзЗ рж╕ржорж╛ржи ржбрж┐рж╕рзНржЯрзНрж░рж┐ржмрж┐ржЙрж╢ржи ржжрзЗржпрж╝ред
```

## ЁЯза рзо. Resource-Based (Adaptive)

```
рж╕рж╛рж░рзНржнрж╛рж░ рж░рж┐рж╕рзЛрж░рзНрж╕ ржоржирж┐ржЯрж░ ржХрж░рзЗ рж╕рж┐ржжрзНржзрж╛ржирзНржд ржирзЗржУржпрж╝рж╛ред

Server Health Metrics:
тФЬтФАтФА CPU Usage
тФЬтФАтФА Memory Usage
тФЬтФАтФА Disk I/O
тФФтФАтФА Network Usage

Server 1: CPU 80%, Memory 70% тЖТ Avoid
Server 2: CPU 30%, Memory 40% тЖТ Good
Server 3: CPU 50%, Memory 60% тЖТ OK

тЖТ Server 2-ржП ржмрзЗрж╢рж┐ ржЯрзНрж░рж╛ржлрж┐ржХ ржкрж╛ржарж╛ржУ
```

## ЁЯУК ржЕрзНржпрж╛рж▓ржЧрж░рж┐ржжржо рждрзБрж▓ржирж╛

```
тФМтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФмтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФР
тФВ    Algorithm        тФВ    Best For                             тФВ
тФЬтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФ╝тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФд
тФВ Round Robin         тФВ рж╕ржорж╛ржи рж╕рж╛рж░рзНржнрж╛рж░, рж╕ржорж╛ржи рж░рж┐ржХрзЛржпрж╝рзЗрж╕рзНржЯ          тФВ
тФВ Weighted RR         тФВ ржнрж┐ржирзНржи ржХрзНрж╖ржорждрж╛рж░ рж╕рж╛рж░рзНржнрж╛рж░                  тФВ
тФВ Least Connections   тФВ рж▓ржВ-рж░рж╛ржирж┐ржВ рж░рж┐ржХрзЛржпрж╝рзЗрж╕рзНржЯ, WebSocket        тФВ
тФВ IP Hash             тФВ рж╕рзЗрж╢ржи ржкрж╛рж░рзНрж╕рж┐рж╕рзНржЯрзЗржирзНрж╕                      тФВ
тФВ Least Response Time тФВ рж▓рзЛ-рж▓рзЗржЯрзЗржирзНрж╕рж┐ ржжрж░ржХрж╛рж░ рж╣рж▓рзЗ                  тФВ
тФВ Random              тФВ рж╕рж┐ржорзНржкрж▓ рж╕рзЗржЯржЖржк, ржмржбрж╝ рж╕рзНржХрзЗрж▓                тФВ
тФВ Resource-Based      тФВ ржнрзНржпрж╛рж░рж┐ржпрж╝рзЗржмрж▓ рж╕рж╛рж░рзНржнрж╛рж░ рж▓рзЛржб                тФВ
тФФтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФ┤тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФШ
```

## ЁЯТб ржХрзЛржи ржЕрзНржпрж╛рж▓ржЧрж░рж┐ржжржо ржмрзЗржЫрзЗ ржирзЗржмрзЗржи?

```
ржкрзНрж░рж╢рзНржи рзз: рж╕рж╛рж░рзНржнрж╛рж░ ржХрж┐ рж╕ржорж╛ржи ржХрзНрж╖ржорждрж╛рж░?
тФЬтФАтФА рж╣рзНржпрж╛ржБ тЖТ Round Robin ржмрж╛ Least Connections
тФФтФАтФА ржирж╛ тЖТ Weighted Algorithm

ржкрзНрж░рж╢рзНржи рзи: рж╕рзЗрж╢ржи ржкрж╛рж░рзНрж╕рж┐рж╕рзНржЯрзЗржирзНрж╕ ржжрж░ржХрж╛рж░?
тФЬтФАтФА рж╣рзНржпрж╛ржБ тЖТ IP Hash ржмрж╛ Sticky Sessions
тФФтФАтФА ржирж╛ тЖТ Other algorithms

ржкрзНрж░рж╢рзНржи рзй: рж░рж┐ржХрзЛржпрж╝рзЗрж╕рзНржЯ рж╕ржоржпрж╝ ржнрзНржпрж╛рж░рж┐ржпрж╝рзЗржмрж▓?
тФЬтФАтФА рж╣рзНржпрж╛ржБ тЖТ Least Connections
тФФтФАтФА ржирж╛ тЖТ Round Robin

ржкрзНрж░рж╢рзНржи рзк: рж▓рзЗржЯрзЗржирзНрж╕рж┐ ржХрзНрж░рж┐ржЯрж┐ржХрзНржпрж╛рж▓?
тФЬтФАтФА рж╣рзНржпрж╛ржБ тЖТ Least Response Time
тФФтФАтФА ржирж╛ тЖТ Other algorithms
```

## ЁЯУЪ ржкрж░ржмрж░рзНрждрзА ржЯржкрж┐ржХ

[рж▓рзЗржпрж╝рж╛рж░ рзк vs рж▓рзЗржпрж╝рж╛рж░ рзн тЖТ](./03-layer4-vs-layer7.md)
